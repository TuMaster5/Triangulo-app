<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triangulo App 2.0</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Babel para transpilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Sun, Moon, Banknote, ClipboardCheck, LayoutDashboard, Settings, Plus, 
          Eye, EyeOff, Save, Download, Copy, Calendar, Upload, FileJson, 
          ArrowUp, ArrowDown, Camera, X, ChevronLeft, ChevronRight, Triangle, 
          Receipt, ShieldCheck, Palette, Percent, Calculator, TrendingUp, MessageSquareText 
        } from 'lucide-react';

        // --- Componente de Navegación ---
        const Navigation = ({ currentView, setView, theme }) => {
          const navItems = [
            { id: 'morning', label: 'Mañana', icon: Sun },
            { id: 'afternoon', label: 'Tarde', icon: Moon },
            { id: 'payments', label: 'Pagos', icon: Banknote },
            { id: 'closure', label: 'Cierre', icon: ClipboardCheck },
            { id: 'summary', label: 'Resumen', icon: LayoutDashboard },
          ];

          const themeActiveColors = {
            indigo: 'text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30',
            emerald: 'text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30',
            rose: 'text-rose-500 bg-rose-50 dark:bg-rose-900/30',
            amber: 'text-amber-500 bg-amber-50 dark:bg-amber-900/30',
            slate: 'text-slate-500 bg-slate-50 dark:bg-slate-900/30'
          };

          return (
            <nav className="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-gray-950/90 backdrop-blur-xl border-t border-gray-100 dark:border-gray-800 px-2 py-2 pb-safe z-50 transition-colors shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
              <div className="flex justify-around items-center max-w-lg mx-auto gap-1">
                {navItems.map((item) => {
                  const Icon = item.icon;
                  const isActive = currentView === item.id;
                  return (
                    <button
                      key={item.id}
                      onClick={() => setView(item.id)}
                      className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 flex-1 ${
                        isActive 
                          ? `${themeActiveColors[theme]} scale-105 shadow-sm` 
                          : 'text-gray-400 dark:text-gray-500 hover:text-gray-600'
                      }`}
                    >
                      <Icon size={22} strokeWidth={isActive ? 2.5 : 2} />
                      <span className={`text-[8px] mt-1 font-black uppercase text-center leading-none tracking-tight ${isActive ? 'opacity-100' : 'opacity-60'}`}>
                        {item.label}
                      </span>
                    </button>
                  );
                })}
              </div>
            </nav>
          );
        };

        // --- Aplicación Principal ---
        const App = () => {
          const [view, setView] = useState('morning');
          const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
          const [theme, setTheme] = useState('indigo');
          const [isDarkMode, setIsDarkMode] = useState(false);
          const [saveStatus, setSaveStatus] = useState('idle');
          
          const [sellers, setSellers] = useState([]);
          const [branches, setBranches] = useState([]);
          const [terminals, setTerminals] = useState([]);
          const [sales, setSales] = useState([]);
          const [payments, setPayments] = useState([]);
          const [branchClosures, setBranchClosures] = useState([]);
          const [terminalEntries, setTerminalEntries] = useState([]);
          const [extraExpenses, setExtraExpenses] = useState([]);

          const [commissionModal, setCommissionModal] = useState({ show: false, sellerId: '', shift: 'morning', tempType: 'none', tempM20: 0, tempM25: 0 });
          const [conceptModal, setConceptModal] = useState({ show: false, type: 'gasto', tempDescription: '' });
          const [paymentCalcModal, setPaymentCalcModal] = useState({ 
            show: false, sellerId: '', 
            startDate: new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0], 
            endDate: new Date().toISOString().split('T')[0], 
            baseSalary: 0 
          });

          const photoInputRef = useRef(null);
          const backupInputRef = useRef(null);
          const [targetIdForPhoto, setTargetIdForPhoto] = useState(null);

          useEffect(() => {
            const data = localStorage.getItem('vendas_app_data');
            if (data) {
              const parsed = JSON.parse(data);
              setSellers(parsed.sellers || []);
              setBranches(parsed.branches || []);
              setTerminals(parsed.terminals || []);
              setSales(parsed.sales || []);
              setPayments(parsed.payments || []);
              setBranchClosures(parsed.branchClosures || []);
              setTerminalEntries(parsed.terminalEntries || []);
              setExtraExpenses(parsed.extraExpenses || []);
              if (parsed.theme) setTheme(parsed.theme);
              if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
            } else {
              setSellers([{ id: '1', name: 'Vendedor 1', active: true, order: 0 }]);
              setBranches([{ id: '1', name: 'Sucursal Central', active: true, order: 0 }]);
              setTerminals([{ id: '1', name: 'Terminal A', active: true, order: 0 }]);
            }
          }, []);

          useEffect(() => {
            const data = { sellers, branches, terminals, sales, payments, branchClosures, terminalEntries, extraExpenses, theme, isDarkMode };
            localStorage.setItem('vendas_app_data', JSON.stringify(data));
          }, [sellers, branches, terminals, sales, payments, branchClosures, terminalEntries, extraExpenses, theme, isDarkMode]);

          useEffect(() => {
            document.documentElement.classList.toggle('dark', isDarkMode);
          }, [isDarkMode]);

          const exportBackup = () => {
            const data = { sellers, branches, terminals, sales, payments, branchClosures, terminalEntries, extraExpenses, theme, isDarkMode };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `triangulo_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const handleImportBackup = (event) => {
            const file = event.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const parsed = JSON.parse(e.target.result);
                if (parsed.sellers) {
                  setSellers(parsed.sellers || []);
                  setBranches(parsed.branches || []);
                  setTerminals(parsed.terminals || []);
                  setSales(parsed.sales || []);
                  setPayments(parsed.payments || []);
                  setBranchClosures(parsed.branchClosures || []);
                  setTerminalEntries(parsed.terminalEntries || []);
                  setExtraExpenses(parsed.extraExpenses || []);
                  if (parsed.theme) setTheme(parsed.theme);
                  if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                  alert('Copia de seguridad cargada.');
                }
              } catch (err) { alert('Archivo JSON inválido.'); }
            };
            reader.readAsText(file);
          };

          const activeSellers = useMemo(() => [...sellers].filter(s => s.active).sort((a, b) => a.order - b.order), [sellers]);
          const activeBranches = useMemo(() => [...branches].filter(b => b.active).sort((a, b) => a.order - b.order), [branches]);
          const activeTerminals = useMemo(() => [...terminals].filter(t => t.active).sort((a, b) => a.order - b.order), [terminals]);

          const themeColors = {
            indigo: { bg: 'bg-indigo-50', text: 'text-indigo-500', border: 'border-indigo-100', btn: 'bg-indigo-500 hover:bg-indigo-600', ring: 'ring-indigo-200', headerText: 'text-indigo-700', dot: 'bg-indigo-500' },
            emerald: { bg: 'bg-emerald-50', text: 'text-emerald-500', border: 'border-emerald-100', btn: 'bg-emerald-500 hover:bg-emerald-600', ring: 'ring-emerald-200', headerText: 'text-emerald-700', dot: 'bg-emerald-500' },
            rose: { bg: 'bg-rose-50', text: 'text-rose-500', border: 'border-rose-100', btn: 'bg-rose-500 hover:bg-rose-600', ring: 'ring-rose-200', headerText: 'text-rose-700', dot: 'bg-rose-500' },
            amber: { bg: 'bg-amber-50', text: 'text-amber-500', border: 'border-amber-100', btn: 'bg-amber-500 hover:bg-amber-600', ring: 'ring-amber-200', headerText: 'text-amber-700', dot: 'bg-amber-500' },
            slate: { bg: 'bg-slate-50', text: 'text-slate-500', border: 'border-slate-100', btn: 'bg-slate-500 hover:bg-slate-600', ring: 'ring-slate-200', headerText: 'text-slate-700', dot: 'bg-slate-500' },
          };

          const getThemeClass = (part) => themeColors[theme][part];
          const baseBg = isDarkMode ? 'bg-gray-950 text-white' : 'bg-gray-50 text-gray-900';
          const cardBg = isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-100';
          const inputBg = isDarkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-700';
          const labelText = isDarkMode ? 'text-gray-400' : 'text-gray-500';
          const mainText = isDarkMode ? 'text-gray-100' : 'text-gray-900';
          const morningFieldBg = isDarkMode ? 'bg-yellow-400/20 border-yellow-500/30' : 'bg-yellow-50 border-yellow-100';
          const afternoonFieldBg = isDarkMode ? 'bg-blue-400/20 border-blue-500/30' : 'bg-blue-50 border-blue-100';

          const formatCurrency = (val) => Math.round(val || 0).toLocaleString();

          const handleSaleChange = (sellerId, shift, value) => {
            const amount = parseFloat(value) || 0;
            setSales(prev => {
              const filtered = prev.filter(s => !(s.date === selectedDate && s.sellerId === sellerId && s.shift === shift));
              const existing = prev.find(s => s.date === selectedDate && s.sellerId === sellerId && s.shift === shift);
              let entry = { 
                date: selectedDate, sellerId, amount, shift, 
                commissionType: existing?.commissionType || 'none', 
                commission: 0,
                mixto20: existing?.mixto20,
                mixto25: existing?.mixto25
              };
              if (entry.commissionType === 'mixto') { entry.commission = (entry.mixto20 || 0) * 0.2 + (entry.mixto25 || 0) * 0.25; }
              else if (entry.commissionType !== 'none') { entry.commission = amount * (parseInt(entry.commissionType) / 100); }
              return [...filtered, entry];
            });
          };

          const saveCommission = () => {
            const { sellerId, shift, tempType, tempM20, tempM25 } = commissionModal;
            setSales(prev => {
              const filtered = prev.filter(s => !(s.date === selectedDate && s.sellerId === sellerId && s.shift === shift));
              const existing = prev.find(s => s.date === selectedDate && s.sellerId === sellerId && s.shift === shift);
              let amount = existing?.amount || 0;
              let commission = 0;
              if (tempType === 'mixto') { amount = tempM20 + tempM25; commission = (tempM20 * 0.2) + (tempM25 * 0.25); }
              else if (tempType !== 'none') { commission = amount * (parseInt(tempType) / 100); }
              return [...filtered, { date: selectedDate, sellerId, amount, shift, commissionType: tempType, commission, mixto20: tempType === 'mixto' ? tempM20 : undefined, mixto25: tempType === 'mixto' ? tempM25 : undefined }];
            });
            setCommissionModal(prev => ({ ...prev, show: false }));
          };

          const changeDate = (offset) => {
            const date = new Date(selectedDate + 'T12:00:00');
            date.setDate(date.getDate() + offset);
            setSelectedDate(date.toISOString().split('T')[0]);
          };

          const handlePaymentChange = (sellerId, shift, value) => {
            const amount = parseFloat(value) || 0;
            setPayments(prev => {
              const filtered = prev.filter(p => !(p.date === selectedDate && p.sellerId === sellerId && p.shift === shift));
              return [...filtered, { date: selectedDate, sellerId, amount, shift }];
            });
          };

          const handleBranchClosureChange = (branchId, field, value) => {
            const amount = parseFloat(value) || 0;
            setBranchClosures(prev => {
              const filtered = prev.filter(bc => !(bc.date === selectedDate && bc.branchId === branchId));
              const existing = prev.find(bc => bc.date === selectedDate && bc.branchId === branchId);
              const newItem = existing ? { ...existing, [field]: amount } : { date: selectedDate, branchId, morningAmount: 0, afternoonAmount: 0, [field]: amount };
              return [...filtered, newItem];
            });
          };

          const saveConcept = () => {
            const { type, tempDescription } = conceptModal;
            setExtraExpenses(prev => {
              const filtered = prev.filter(e => !(e.date === selectedDate && e.type === type));
              const m = prev.find(e => e.date === selectedDate && e.type === type && e.shift === 'morning')?.amount || 0;
              const a = prev.find(e => e.date === selectedDate && e.type === type && e.shift === 'afternoon')?.amount || 0;
              return [...filtered, { date: selectedDate, type, amount: m, shift: 'morning', description: tempDescription }, { date: selectedDate, type, amount: a, shift: 'afternoon', description: tempDescription }];
            });
            setConceptModal(prev => ({ ...prev, show: false }));
          };

          const handleExtraExpenseChange = (type, shift, value) => {
            const amount = parseFloat(value) || 0;
            setExtraExpenses(prev => {
              const filtered = prev.filter(e => !(e.date === selectedDate && e.type === type && e.shift === shift));
              const existing = prev.find(e => e.date === selectedDate && e.type === type);
              return [...filtered, { date: selectedDate, type, amount, shift, description: existing?.description || '' }];
            });
          };

          const handleTerminalChange = (terminalId, shift, value) => {
            const amount = parseFloat(value) || 0;
            setTerminalEntries(prev => {
              const filtered = prev.filter(te => !(te.date === selectedDate && te.terminalId === terminalId && te.shift === shift));
              return [...filtered, { date: selectedDate, terminalId, amount, shift }];
            });
          };

          const summaryData = useMemo(() => {
            const dayClosures = branchClosures.filter(b => b.date === selectedDate);
            const dayPayments = payments.filter(p => p.date === selectedDate);
            const dayTerminals = terminalEntries.filter(t => t.date === selectedDate);
            const dayExtras = extraExpenses.filter(e => e.date === selectedDate);
            const detailByBranch = activeBranches.map(br => { const d = dayClosures.find(c => c.branchId === br.id); return { name: br.name, total: (d?.morningAmount || 0) + (d?.afternoonAmount || 0) }; });
            const groupedPayments = dayPayments.reduce((acc, p) => { const s = sellers.find(sel => sel.id === p.sellerId); const name = s ? s.name : 'Vendedor'; if (!acc[p.sellerId]) acc[p.sellerId] = { name, amount: 0 }; acc[p.sellerId].amount += p.amount; return acc; }, {});
            const paymentsBySeller = Object.values(groupedPayments).filter(p => p.amount > 0);
            const totalGross = detailByBranch.reduce((acc, b) => acc + b.total, 0);
            const totalPayments = dayPayments.reduce((acc, p) => acc + p.amount, 0);
            const groupedExtras = dayExtras.reduce((acc, e) => { const key = e.type === 'gasto' ? (e.description || 'Gasto') : 'Garantía'; if (!acc[key]) acc[key] = { amount: 0, type: e.type }; acc[key].amount += e.amount; return acc; }, {});
            const totalGastos = dayExtras.filter(e => e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
            const totalGarantias = dayExtras.filter(e => e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
            const totalDeductions = totalPayments + totalGastos + totalGarantias;
            const totalDay = totalGross - totalDeductions;
            const totalTerminals = dayTerminals.reduce((acc, t) => acc + t.amount, 0);
            const totalCash = totalDay - totalTerminals;
            return { date: selectedDate, detailByBranch, paymentsBySeller, totalGross, totalPayments, totalGastos, totalGarantias, totalDeductions, totalDay, totalTerminals, totalCash, groupedExtras };
          }, [selectedDate, sellers, activeBranches, branchClosures, payments, terminalEntries, extraExpenses]);

          const copySummaryText = () => {
            const formatDateSpanish = (dateStr) => { const [y, m, d] = dateStr.split('-').map(Number); const date = new Date(y, m - 1, d); return date.toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); };
            const text = `${formatDateSpanish(summaryData.date)}\n\nDETALLE SUCURSALES:\n${summaryData.detailByBranch.map(b => `${b.name}: $${formatCurrency(b.total)}`).join('\n')}\nTOTAL VENTAS: $${formatCurrency(summaryData.totalGross)}\n\nDEDUCCIONES:\n${summaryData.paymentsBySeller.map(p => `- ${p.name}: $${formatCurrency(p.amount)}`).join('\n')}\nTOTAL DEDUCCIONES: $${formatCurrency(summaryData.totalDeductions)}\n\n*TOTAL DÍA: $${formatCurrency(summaryData.totalDay)}*\nTOTAL EFECTIVO: $${formatCurrency(summaryData.totalCash)}`;
            navigator.clipboard.writeText(text);
            alert('Copiado');
          };

          const VisualPreview = ({ source, size = "10", hasCalculated = false, onClick }) => (
            <div onClick={onClick} className={`w-${size} h-${size} rounded-xl overflow-hidden border border-gray-200 cursor-pointer shadow-sm ${hasCalculated ? 'ring-2 ring-emerald-500 ring-offset-1' : ''}`}>
              {source ? <img src={source} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-gray-400"><Camera size={18}/></div>}
            </div>
          );

          return (
            <div className={`min-h-screen pb-24 ${baseBg} transition-colors duration-500`}>
              <header className={`${getThemeClass('bg')} ${getThemeClass('headerText')} p-4 sticky top-0 z-50 flex justify-between items-center shadow-md`}>
                <div className="flex items-center gap-2">
                  <Triangle size={20} fill="currentColor" />
                  <h1 className="text-xl font-black uppercase tracking-widest">TRIANGULO</h1>
                </div>
                <button onClick={() => setView(view === 'settings' ? 'morning' : 'settings')} className="p-2 bg-white/20 rounded-full">
                  <Settings size={22} />
                </button>
              </header>

              <div className={`${cardBg} border-b p-2 flex items-center justify-between sticky top-[60px] z-40`}>
                <button onClick={() => changeDate(-1)} className="p-2"><ChevronLeft size={24}/></button>
                <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 dark:bg-gray-800 rounded-xl border">
                  <Calendar size={18}/>
                  <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent text-sm font-bold outline-none cursor-pointer" />
                </div>
                <button onClick={() => changeDate(1)} className="p-2"><ChevronRight size={24}/></button>
              </div>

              <main className="p-4 max-w-lg mx-auto w-full">
                {(view === 'morning' || view === 'afternoon') && (
                  <div className="space-y-4 animate-in">
                    <div className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
                      <h2 className="text-xs font-black uppercase tracking-widest mb-4 opacity-60">Ventas {view === 'morning' ? 'Mañana' : 'Tarde'}</h2>
                      <div className="space-y-3">
                        {activeSellers.map(seller => {
                          const entry = sales.find(s => s.date === selectedDate && s.sellerId === seller.id && s.shift === view);
                          return (
                            <div key={seller.id} className={`flex items-center justify-between p-3 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-50'} rounded-xl border`}>
                              <div className="flex items-center gap-3">
                                <VisualPreview source={seller.image} hasCalculated={entry?.commissionType && entry.commissionType !== 'none'} onClick={() => setCommissionModal({ show: true, sellerId: seller.id, shift: view, tempType: entry?.commissionType || 'none', tempM20: entry?.mixto20 || 0, tempM25: entry?.mixto25 || 0 })} />
                                <div className="flex flex-col">
                                  <span className="font-bold text-sm">{seller.name}</span>
                                  {entry?.commission > 0 && <span className="text-[10px] text-emerald-500 font-black">Com: ${formatCurrency(entry.commission)}</span>}
                                </div>
                              </div>
                              <div className="relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 opacity-40 font-bold">$</span>
                                <input type="number" value={entry?.amount || ''} onChange={(e) => handleSaleChange(seller.id, view, e.target.value)} className={`w-24 pl-7 pr-3 py-2 ${inputBg} rounded-lg text-right font-black shadow-inner`} />
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {view === 'payments' && (
                  <div className="space-y-4 animate-in">
                    <div className={`${cardBg} p-4 rounded-2xl border`}>
                      <h2 className="text-xs font-black uppercase tracking-widest mb-4 opacity-60">Pagos a Vendedores</h2>
                      <div className="space-y-4">
                        {activeSellers.map(seller => {
                          const amtM = payments.find(p => p.date === selectedDate && p.sellerId === seller.id && p.shift === 'morning')?.amount || 0;
                          const amtT = payments.find(p => p.date === selectedDate && p.sellerId === seller.id && p.shift === 'afternoon')?.amount || 0;
                          return (
                            <div key={seller.id} className="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border">
                              <div className="flex items-center gap-3 mb-3">
                                <VisualPreview source={seller.image} hasCalculated={payments.some(p => p.date === selectedDate && p.sellerId === seller.id && p.calculated)} onClick={() => setPaymentCalcModal({ ...paymentCalcModal, show: true, sellerId: seller.id })} />
                                <span className="font-bold">{seller.name}</span>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div className="relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-rose-500 font-bold text-xs">$ M</span><input type="number" value={amtM || ''} onChange={(e) => handlePaymentChange(seller.id, 'morning', e.target.value)} className="w-full pl-8 pr-2 py-2 bg-white dark:bg-gray-700 rounded-lg text-right font-black border" /></div>
                                <div className="relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-rose-500 font-bold text-xs">$ T</span><input type="number" value={amtT || ''} onChange={(e) => handlePaymentChange(seller.id, 'afternoon', e.target.value)} className="w-full pl-8 pr-2 py-2 bg-white dark:bg-gray-700 rounded-lg text-right font-black border" /></div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {view === 'closure' && (
                  <div className="space-y-4 animate-in">
                    {activeBranches.map(branch => {
                      const d = branchClosures.find(bc => bc.date === selectedDate && bc.branchId === branch.id) || { morningAmount: 0, afternoonAmount: 0 };
                      return (
                        <div key={branch.id} className={`${cardBg} p-4 rounded-2xl border`}>
                          <div className="flex items-center gap-3 mb-4"><VisualPreview source={branch.image} /><h3 className="font-black uppercase tracking-tight">{branch.name}</h3></div>
                          <div className="grid grid-cols-2 gap-4">
                            <input type="number" placeholder="Mañana" value={d.morningAmount || ''} onChange={(e) => handleBranchClosureChange(branch.id, 'morningAmount', e.target.value)} className={`w-full p-3 ${morningFieldBg} rounded-xl font-black text-center border`} />
                            <input type="number" placeholder="Tarde" value={d.afternoonAmount || ''} onChange={(e) => handleBranchClosureChange(branch.id, 'afternoonAmount', e.target.value)} className={`w-full p-3 ${afternoonFieldBg} rounded-xl font-black text-center border`} />
                          </div>
                        </div>
                      );
                    })}
                    <div className={`${cardBg} p-4 rounded-2xl border`}>
                      <h3 className="text-xs font-black uppercase mb-4 opacity-60">Gastos y Garantías</h3>
                      <div className="space-y-4">
                        {['gasto', 'garantia'].map(type => (
                          <div key={type} className="space-y-2">
                            <div className="flex justify-between items-center"><span className="text-[10px] font-black uppercase">{type === 'gasto' ? 'Gastos' : 'Garantías'}</span><button onClick={() => openConceptModal(type)} className="text-[10px] text-indigo-500 font-black flex items-center gap-1"><MessageSquareText size={12}/> CONCEPTO</button></div>
                            <div className="grid grid-cols-2 gap-3">
                              <input type="number" placeholder="M" value={extraExpenses.find(e => e.date === selectedDate && e.type === type && e.shift === 'morning')?.amount || ''} onChange={(e) => handleExtraExpenseChange(type, 'morning', e.target.value)} className="w-full p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-center font-black border" />
                              <input type="number" placeholder="T" value={extraExpenses.find(e => e.date === selectedDate && e.type === type && e.shift === 'afternoon')?.amount || ''} onChange={(e) => handleExtraExpenseChange(type, 'afternoon', e.target.value)} className="w-full p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-center font-black border" />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {view === 'summary' && (
                  <div className="animate-in space-y-4">
                    <div className={`${cardBg} p-6 rounded-3xl shadow-xl border overflow-hidden relative cursor-pointer`} onClick={copySummaryText}>
                      <h2 className={`font-black text-2xl mb-6 tracking-tighter`}>{summaryData.date}</h2>
                      <div className="space-y-4">
                        <div className="space-y-1">
                          {summaryData.detailByBranch.map((b, i) => (<div key={i} className="flex justify-between text-sm py-1 border-b border-gray-100 dark:border-gray-800"><span>{b.name}</span><span className="font-black">$ {formatCurrency(b.total)}</span></div>))}
                          <div className="flex justify-between font-black text-lg pt-2 text-indigo-500"><span>VENTAS</span><span>$ {formatCurrency(summaryData.totalGross)}</span></div>
                        </div>
                        <div className="pt-4 border-t border-gray-100 dark:border-gray-800">
                          <h3 className="text-[10px] font-black uppercase opacity-60 mb-2">Deducciones</h3>
                          {summaryData.paymentsBySeller.map((p, i) => (<div key={i} className="flex justify-between text-xs py-1 italic opacity-70"><span>{p.name}</span><span>-$ {formatCurrency(p.amount)}</span></div>))}
                          {Object.entries(summaryData.groupedExtras).map(([k, d]) => d.amount > 0 && <div key={k} className="flex justify-between text-xs py-1"><span>{k}</span><span className="text-rose-500">-$ {formatCurrency(d.amount)}</span></div>)}
                          <div className="flex justify-between text-sm font-black pt-2 text-rose-500"><span>TOTAL DED.</span><span>-$ {formatCurrency(summaryData.totalDeductions)}</span></div>
                        </div>
                        <div className="pt-6 border-t border-gray-100 dark:border-gray-800 flex justify-between text-xl font-black"><span>TOTAL DÍA</span><span>$ {formatCurrency(summaryData.totalDay)}</span></div>
                      </div>
                      <div className="mt-8 p-6 rounded-2xl bg-indigo-500 text-white text-center shadow-lg">
                        <p className="text-[10px] uppercase font-black opacity-60 mb-1">Efectivo a Entregar</p>
                        <p className="text-4xl font-black">$ {formatCurrency(summaryData.totalCash)}</p>
                      </div>
                    </div>
                  </div>
                )}

                {view === 'settings' && (
                  <div className="space-y-6 animate-in">
                    <div className={`${cardBg} p-5 rounded-2xl border`}>
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="font-black text-lg tracking-tight">Personalización</h2>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 bg-gray-100 dark:bg-gray-800 rounded-xl">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                      </div>
                      <div className="flex gap-2">{(['indigo', 'emerald', 'rose', 'amber', 'slate']).map(t => (<button key={t} onClick={() => setTheme(t)} className={`w-8 h-8 rounded-full border-2 ${theme === t ? 'border-gray-400 ring-2' : 'border-transparent'} ${themeColors[t].dot}`} />))}</div>
                    </div>
                    <div className={`${cardBg} p-5 rounded-2xl border`}>
                      <h2 className="font-black text-lg mb-4">Copia de Seguridad</h2>
                      <div className="grid grid-cols-2 gap-3">
                        <button onClick={exportBackup} className="flex items-center justify-center gap-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-black text-xs border"><Download size={18}/> EXPORTAR</button>
                        <button onClick={() => backupInputRef.current?.click()} className="flex items-center justify-center gap-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-black text-xs border"><Upload size={18}/> IMPORTAR</button>
                        <input type="file" ref={backupInputRef} onChange={handleImportBackup} className="hidden" accept=".json" />
                      </div>
                    </div>
                    {[{ label: 'Vendedores', type: 'seller', items: sellers }, { label: 'Sucursales', type: 'branch', items: branches }, { label: 'Terminales', type: 'terminal', items: terminals }].map(section => (
                      <div key={section.type} className={`${cardBg} p-5 rounded-2xl border`}>
                        <div className="flex justify-between items-center mb-5"><h2 className="font-black text-xl tracking-tight">{section.label}</h2><button onClick={() => { const id = Date.now().toString(); const item = { id, name: 'Nuevo', active: true, order: section.items.length }; if (section.type === 'seller') setSellers([...sellers, item]); else if (section.type === 'branch') setBranches([...branches, item]); else setTerminals([...terminals, item]); }} className="p-2 px-4 bg-indigo-500 text-white rounded-full text-xs font-black shadow-sm">+ AÑADIR</button></div>
                        <div className="space-y-3">
                          {section.items.map(item => (
                            <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border">
                              <div className="flex items-center gap-3 flex-1">
                                <VisualPreview source={item.image} onClick={() => { setTargetIdForPhoto({ id: item.id, type: section.type }); photoInputRef.current?.click(); }} />
                                <input type="text" value={item.name} onChange={(e) => { const n = e.target.value; if (section.type === 'seller') setSellers(s => s.map(x => x.id === item.id ? {...x, name: n} : x)); else if (section.type === 'branch') setBranches(b => b.map(x => x.id === item.id ? {...x, name: n} : x)); else setTerminals(t => t.map(x => x.id === item.id ? {...x, name: n} : x)); }} className="bg-transparent font-black outline-none w-full" />
                              </div>
                              <button onClick={() => { if (section.type === 'seller') setSellers(s => s.map(x => x.id === item.id ? {...x, active: !x.active} : x)); else if (section.type === 'branch') setBranches(b => b.map(x => x.id === item.id ? {...x, active: !x.active} : x)); else setTerminals(t => t.map(x => x.id === item.id ? {...x, active: !x.active} : x)); }} className="p-2 text-gray-400">{item.active ? <Eye size={18}/> : <EyeOff size={18}/>}</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </main>

              <Navigation currentView={view} setView={setView} theme={theme} />

              {/* MODALS */}
              {commissionModal.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
                  <div className={`${cardBg} w-full max-w-sm rounded-3xl border overflow-hidden`}>
                    <div className="p-6 space-y-6">
                      <div className="flex justify-between items-center"><h3 className="font-black uppercase tracking-widest text-indigo-500">Comisión</h3><button onClick={() => setCommissionModal({ ...commissionModal, show: false })}><X/></button></div>
                      <div className="flex gap-2">
                        {['10', '20', '25', 'mixto', 'none'].map(t => (<button key={t} onClick={() => setCommissionModal({ ...commissionModal, tempType: t })} className={`flex-1 py-3 text-[10px] font-black rounded-xl border ${commissionModal.tempType === t ? 'bg-indigo-500 text-white' : 'bg-gray-100 dark:bg-gray-800'}`}>{t === 'mixto' ? 'MIX' : t === 'none' ? 'SIN' : `${t}%`}</button>))}
                      </div>
                      {commissionModal.tempType === 'mixto' && (
                        <div className="grid grid-cols-2 gap-4">
                          <input type="number" placeholder="Venta 20%" value={commissionModal.tempM20 || ''} onChange={(e) => setCommissionModal({ ...commissionModal, tempM20: parseFloat(e.target.value) || 0 })} className={`w-full p-3 ${inputBg} rounded-xl border font-black`} />
                          <input type="number" placeholder="Venta 25%" value={commissionModal.tempM25 || ''} onChange={(e) => setCommissionModal({ ...commissionModal, tempM25: parseFloat(e.target.value) || 0 })} className={`w-full p-3 ${inputBg} rounded-xl border font-black`} />
                        </div>
                      )}
                      <button onClick={saveCommission} className="w-full py-4 bg-indigo-500 text-white rounded-2xl font-black shadow-lg">GUARDAR</button>
                    </div>
                  </div>
                </div>
              )}

              {paymentCalcModal.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
                  <div className={`${cardBg} w-full max-w-sm rounded-3xl border overflow-hidden max-h-[90vh] flex flex-col`}>
                    <div className="p-6 border-b flex justify-between items-center"><h3 className="font-black uppercase tracking-widest text-indigo-500">Cálculo Pago</h3><button onClick={() => setPaymentCalcModal({ ...paymentCalcModal, show: false })}><X/></button></div>
                    <div className="p-6 overflow-y-auto space-y-4">
                      <div className="grid grid-cols-2 gap-2">
                        <input type="date" value={paymentCalcModal.startDate} onChange={(e) => setPaymentCalcModal({...paymentCalcModal, startDate: e.target.value})} className={`p-2 text-xs rounded-lg border ${inputBg}`} />
                        <input type="date" value={paymentCalcModal.endDate} onChange={(e) => setPaymentCalcModal({...paymentCalcModal, endDate: e.target.value})} className={`p-2 text-xs rounded-lg border ${inputBg}`} />
                      </div>
                      <div className="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                        {sales.filter(s => s.sellerId === paymentCalcModal.sellerId && s.date >= paymentCalcModal.startDate && s.date <= paymentCalcModal.endDate && s.commission > 0).map((s, i) => (
                          <div key={i} className="flex justify-between text-[10px] font-bold"><span>{s.date} {s.shift==='morning'?'M':'T'}</span><span className="text-emerald-500">$ {formatCurrency(s.commission)}</span></div>
                        ))}
                      </div>
                      <input type="number" placeholder="Sueldo Base" value={paymentCalcModal.baseSalary || ''} onChange={(e) => setPaymentCalcModal({...paymentCalcModal, baseSalary: parseFloat(e.target.value) || 0})} className={`w-full p-3 rounded-xl border ${inputBg} font-black`} />
                      {(() => {
                        const coms = sales.filter(s => s.sellerId === paymentCalcModal.sellerId && s.date >= paymentCalcModal.startDate && s.date <= paymentCalcModal.endDate).reduce((acc, c) => acc + (c.commission || 0), 0);
                        const prev = payments.filter(p => p.sellerId === paymentCalcModal.sellerId && p.date >= paymentCalcModal.startDate && p.date <= paymentCalcModal.endDate).reduce((acc, c) => acc + c.amount, 0);
                        const total = coms + paymentCalcModal.baseSalary - prev;
                        return (
                          <div className="p-5 bg-indigo-500 text-white rounded-2xl text-center space-y-4">
                            <div><p className="text-[10px] font-black uppercase opacity-60">Cobrar</p><p className="text-4xl font-black">$ {formatCurrency(total)}</p></div>
                            <div className="flex gap-2">
                              <button onClick={() => { setPayments([...payments.filter(p => !(p.date===selectedDate && p.sellerId===paymentCalcModal.sellerId && p.shift==='morning')), { date: selectedDate, sellerId: paymentCalcModal.sellerId, amount: Math.ceil(total), shift: 'morning', calculated: true }]); setPaymentCalcModal({...paymentCalcModal, show: false}); }} className="flex-1 py-2 bg-white/20 rounded-lg text-[9px] font-black uppercase">M</button>
                              <button onClick={() => { setPayments([...payments.filter(p => !(p.date===selectedDate && p.sellerId===paymentCalcModal.sellerId && p.shift==='afternoon')), { date: selectedDate, sellerId: paymentCalcModal.sellerId, amount: Math.ceil(total), shift: 'afternoon', calculated: true }]); setPaymentCalcModal({...paymentCalcModal, show: false}); }} className="flex-1 py-2 bg-white/20 rounded-lg text-[9px] font-black uppercase">T</button>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </div>
              )}

              {conceptModal.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
                  <div className={`${cardBg} w-full max-w-sm rounded-3xl border overflow-hidden`}>
                    <div className="p-6 space-y-4">
                      <h3 className="font-black uppercase tracking-widest text-rose-500">Concepto {conceptModal.type}</h3>
                      <textarea value={conceptModal.tempDescription} onChange={(e) => setConceptModal({ ...conceptModal, tempDescription: e.target.value })} className={`w-full p-4 h-32 ${inputBg} border rounded-2xl font-medium text-sm outline-none resize-none`} placeholder="Describe el gasto..." />
                      <button onClick={saveConcept} className="w-full py-4 bg-rose-500 text-white rounded-2xl font-black">GUARDAR</button>
                    </div>
                  </div>
                </div>
              )}

              <input type="file" ref={photoInputRef} className="hidden" accept="image/*" onChange={async (e) => {
                const f = e.target.files?.[0]; if (!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                  const img = new Image();
                  img.onload = () => {
                    const canvas = document.createElement('canvas'); const scale = 120 / img.width; canvas.width = 120; canvas.height = img.height * scale;
                    canvas.getContext('2d')?.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.6);
                    if (targetIdForPhoto.type === 'seller') setSellers(s => s.map(x => x.id === targetIdForPhoto.id ? {...x, image: b64} : x));
                    else if (targetIdForPhoto.type === 'branch') setBranches(b => b.map(x => x.id === targetIdForPhoto.id ? {...x, image: b64} : x));
                    else if (targetIdForPhoto.type === 'terminal') setTerminals(t => t.map(x => x.id === targetIdForPhoto.id ? {...x, image: b64} : x));
                  };
                  img.src = ev.target?.result;
                };
                r.readAsDataURL(f);
              }} />
            </div>
          );
        };

        const rootElement = document.getElementById('root');
        createRoot(rootElement).render(<App />);
    </script>
</body>
</html>
