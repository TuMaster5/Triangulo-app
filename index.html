<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIANGULO APP - Gestor de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .view-transition { transition: opacity 0.2s ease-in-out; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-900 overflow-x-hidden pb-24">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i data-lucide="triangle" class="fill-white"></i>
            <h1 class="text-xl font-black tracking-tighter">TRIANGULO APP</h1>
        </div>
        <button onclick="changeView('settings')" class="p-2 bg-white/20 rounded-full">
            <i data-lucide="settings" size="20"></i>
        </button>
    </header>

    <!-- Date Selector -->
    <div class="p-2 border-b flex items-center justify-between sticky top-[60px] z-40 bg-white/80 backdrop-blur-md">
        <button onclick="addDays(-1)" class="p-2 text-indigo-600"><i data-lucide="chevron-left"></i></button>
        <div class="flex items-center gap-2 px-4 py-2 rounded-xl border bg-gray-50">
            <i data-lucide="calendar" size="18" class="text-indigo-600"></i>
            <input type="date" id="dateInput" onchange="handleDateChange()" class="bg-transparent text-sm font-bold focus:outline-none cursor-pointer">
        </div>
        <button onclick="addDays(1)" class="p-2 text-indigo-600"><i data-lucide="chevron-right"></i></button>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="p-4 max-w-lg mx-auto w-full view-transition">
        <!-- Contenido inyectado por JS -->
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-gray-100 px-2 py-2 pb-safe z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center max-w-lg mx-auto gap-1">
            <button onclick="changeView('morning')" id="nav-morning" class="flex flex-col items-center justify-center p-2 rounded-xl flex-1 text-gray-400">
                <i data-lucide="sun" size="22"></i>
                <span class="text-[8px] mt-1 font-black uppercase">Mañana</span>
            </button>
            <button onclick="changeView('afternoon')" id="nav-afternoon" class="flex flex-col items-center justify-center p-2 rounded-xl flex-1 text-gray-400">
                <i data-lucide="moon" size="22"></i>
                <span class="text-[8px] mt-1 font-black uppercase">Tarde</span>
            </button>
            <button onclick="changeView('payments')" id="nav-payments" class="flex flex-col items-center justify-center p-2 rounded-xl flex-1 text-gray-400">
                <i data-lucide="banknote" size="22"></i>
                <span class="text-[8px] mt-1 font-black uppercase">Pagos</span>
            </button>
            <button onclick="changeView('summary')" id="nav-summary" class="flex flex-col items-center justify-center p-2 rounded-xl flex-1 text-gray-400">
                <i data-lucide="layout-dashboard" size="22"></i>
                <span class="text-[8px] mt-1 font-black uppercase">Resumen</span>
            </button>
        </div>
    </nav>

    <script>
        // --- State ---
        let state = {
            currentView: 'morning',
            selectedDate: new Date().toISOString().split('T')[0],
            sellers: [
                { id: 's1', name: 'Vendedor 1', active: true },
                { id: 's2', name: 'Vendedor 2', active: true }
            ],
            branches: [
                { id: 'b1', name: 'Sucursal Central', active: true },
                { id: 'b2', name: 'Virtual', active: true }
            ],
            terminals: [{ id: 't1', name: 'Terminal A', active: true }],
            sales: [], // { date, sellerId, amount, shift }
            payments: [], // { date, sellerId, amount, shift }
            closures: [], // { date, branchId, morning, afternoon }
            extras: [], // { date, type, amount, shift, description }
            terminalEntries: [] // { date, terminalId, amount, shift }
        };

        // --- Persistence ---
        function loadState() {
            const saved = localStorage.getItem('triangulo_app_vanilla');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            }
            document.getElementById('dateInput').value = state.selectedDate;
        }

        function saveState() {
            localStorage.setItem('triangulo_app_vanilla', JSON.stringify(state));
        }

        // --- Helpers ---
        function formatCurrency(val) {
            return Math.round(val || 0).toLocaleString('en-US');
        }

        function formatDateSpanish(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const weekday = date.toLocaleDateString('es-ES', { weekday: 'long' });
            const monthLabel = date.toLocaleDateString('es-ES', { month: 'long' });
            return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${day} de ${monthLabel} ${year}`;
        }

        // --- Actions ---
        function changeView(view) {
            state.currentView = view;
            render();
        }

        function handleDateChange() {
            state.selectedDate = document.getElementById('dateInput').value;
            render();
        }

        function addDays(n) {
            const d = new Date(state.selectedDate + 'T12:00:00');
            d.setDate(d.getDate() + n);
            state.selectedDate = d.toISOString().split('T')[0];
            document.getElementById('dateInput').value = state.selectedDate;
            render();
        }

        // --- Logic ---
        function updateValue(arrayName, key, matchObj, value) {
            const val = parseFloat(value) || 0;
            state[arrayName] = state[arrayName].filter(x => {
                return !Object.keys(matchObj).every(k => x[k] === matchObj[k]);
            });
            state[arrayName].push({ ...matchObj, [key]: val });
            saveState();
        }

        function getVal(arrayName, matchObj, key) {
            const found = state[arrayName].find(x => {
                return !Object.keys(matchObj).every(k => x[k] === matchObj[k]);
            }); // This logic is wrong, fixing:
        }

        // Optimized Getter
        function findVal(arrayName, matchObj, key) {
            const found = state[arrayName].find(x => 
                Object.keys(matchObj).every(k => x[k] === matchObj[k])
            );
            return found ? (found[key] || 0) : 0;
        }

        // --- Rendering ---
        function render() {
            const main = document.getElementById('mainContent');
            main.style.opacity = '0';
            
            setTimeout(() => {
                main.innerHTML = '';
                updateNav();

                if (state.currentView === 'morning' || state.currentView === 'afternoon') {
                    renderSalesView(main, state.currentView);
                } else if (state.currentView === 'payments') {
                    renderPaymentsView(main);
                } else if (state.currentView === 'summary') {
                    renderSummaryView(main);
                } else if (state.currentView === 'settings') {
                    renderSettingsView(main);
                }
                
                lucide.createIcons();
                main.style.opacity = '1';
            }, 100);
        }

        function updateNav() {
            ['morning', 'afternoon', 'payments', 'summary'].forEach(v => {
                const btn = document.getElementById('nav-' + v);
                if (!btn) return;
                if (state.currentView === v) {
                    btn.classList.add('text-indigo-600', 'bg-indigo-50');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-indigo-600', 'bg-indigo-50');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        function renderSalesView(container, shift) {
            const activeSellers = state.sellers.filter(s => s.active);
            let html = `<div class="bg-white p-4 rounded-3xl shadow-sm border space-y-3">
                <h2 class="text-[10px] font-black uppercase tracking-widest border-b pb-2 opacity-50">Ventas ${shift === 'morning' ? 'Mañana' : 'Tarde'}</h2>`;
            
            activeSellers.forEach(s => {
                const val = findVal('sales', { date: state.selectedDate, sellerId: s.id, shift }, 'amount');
                html += `
                <div class="flex items-center justify-between p-2 rounded-xl border bg-gray-50/50">
                    <span class="font-bold text-sm ml-2">${s.name}</span>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-40 font-bold">$</span>
                        <input type="number" value="${val || ''}" 
                            oninput="updateValue('sales', 'amount', { date: '${state.selectedDate}', sellerId: '${s.id}', shift: '${shift}' }, this.value)"
                            class="w-32 pl-7 pr-3 py-2 rounded-lg text-right font-black shadow-inner border-transparent focus:border-indigo-300 outline-none">
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderPaymentsView(container) {
            const activeSellers = state.sellers.filter(s => s.active);
            let html = `<div class="bg-white p-4 rounded-3xl shadow-sm border space-y-4">
                <h2 class="text-[10px] font-black uppercase tracking-widest border-b pb-2 opacity-50">Pagos a Vendedores</h2>`;
            
            activeSellers.forEach(s => {
                const mVal = findVal('payments', { date: state.selectedDate, sellerId: s.id, shift: 'morning' }, 'amount');
                const aVal = findVal('payments', { date: state.selectedDate, sellerId: s.id, shift: 'afternoon' }, 'amount');
                html += `
                <div class="p-3 border rounded-2xl bg-gray-50/30">
                    <p class="font-bold mb-2 ml-1 text-sm">${s.name}</p>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative">
                            <input type="number" placeholder="Mañana" value="${mVal || ''}" 
                                oninput="updateValue('payments', 'amount', { date: '${state.selectedDate}', sellerId: '${s.id}', shift: 'morning' }, this.value)"
                                class="w-full p-2 bg-yellow-50 border-yellow-100 border rounded-lg text-right font-black text-yellow-700 outline-none">
                        </div>
                        <div class="relative">
                            <input type="number" placeholder="Tarde" value="${aVal || ''}" 
                                oninput="updateValue('payments', 'amount', { date: '${state.selectedDate}', sellerId: '${s.id}', shift: 'afternoon' }, this.value)"
                                class="w-full p-2 bg-blue-50 border-blue-100 border rounded-lg text-right font-black text-blue-700 outline-none">
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderSummaryView(container) {
            const activeBranches = state.branches.filter(b => b.active);
            const activeTerminals = state.terminals.filter(t => t.active);
            
            // Cierre de Sucursales
            let html = `<div class="bg-white p-4 rounded-3xl shadow-sm border space-y-4 mb-4">
                <h2 class="text-[10px] font-black uppercase tracking-widest opacity-50 flex items-center gap-2"><i data-lucide="clipboard-check" size="14"></i> Cierre Sucursales</h2>`;
            
            activeBranches.forEach(b => {
                const mVal = findVal('closures', { date: state.selectedDate, branchId: b.id }, 'morning');
                const aVal = findVal('closures', { date: state.selectedDate, branchId: b.id }, 'afternoon');
                html += `
                <div class="space-y-2 border-b border-gray-50 pb-3">
                    <p class="text-xs font-black uppercase opacity-60 ml-1">${b.name}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" placeholder="Mañana" value="${mVal || ''}" 
                            oninput="updateValue('closures', 'morning', { date: '${state.selectedDate}', branchId: '${b.id}' }, this.value)"
                            class="p-2 bg-yellow-50/50 border rounded-xl text-right font-black outline-none focus:ring-2 focus:ring-yellow-200">
                        <input type="number" placeholder="Tarde" value="${aVal || ''}" 
                            oninput="updateValue('closures', 'afternoon', { date: '${state.selectedDate}', branchId: '${b.id}' }, this.value)"
                            class="p-2 bg-blue-50/50 border rounded-xl text-right font-black outline-none focus:ring-2 focus:ring-blue-200">
                    </div>
                </div>`;
            });
            html += `</div>`;

            // Extras (Gastos) y Terminales
            html += `<div class="bg-white p-4 rounded-3xl shadow-sm border space-y-4 mb-4">
                <h2 class="text-[10px] font-black uppercase tracking-widest opacity-50">Gastos y Terminales</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black opacity-40 uppercase ml-1">Gastos (M/T)</label>
                        <input type="number" placeholder="M" value="${findVal('extras', { date: state.selectedDate, type: 'gasto', shift: 'morning' }, 'amount') || ''}" 
                            oninput="updateValue('extras', 'amount', { date: '${state.selectedDate}', type: 'gasto', shift: 'morning', description: 'Gasto' }, this.value)"
                            class="w-full p-2 bg-rose-50 border rounded-lg mb-1 text-right font-bold text-rose-600">
                        <input type="number" placeholder="T" value="${findVal('extras', { date: state.selectedDate, type: 'gasto', shift: 'afternoon' }, 'amount') || ''}" 
                            oninput="updateValue('extras', 'amount', { date: '${state.selectedDate}', type: 'gasto', shift: 'afternoon', description: 'Gasto' }, this.value)"
                            class="w-full p-2 bg-rose-50 border rounded-lg text-right font-bold text-rose-600">
                    </div>`;
            
            activeTerminals.forEach(t => {
                html += `
                <div class="space-y-1">
                    <label class="text-[9px] font-black opacity-40 uppercase ml-1">${t.name}</label>
                    <input type="number" placeholder="M" value="${findVal('terminalEntries', { date: state.selectedDate, terminalId: t.id, shift: 'morning' }, 'amount') || ''}" 
                        oninput="updateValue('terminalEntries', 'amount', { date: '${state.selectedDate}', terminalId: '${t.id}', shift: 'morning' }, this.value)"
                        class="w-full p-2 bg-emerald-50 border rounded-lg mb-1 text-right font-bold text-emerald-600">
                    <input type="number" placeholder="T" value="${findVal('terminalEntries', { date: state.selectedDate, terminalId: t.id, shift: 'afternoon' }, 'amount') || ''}" 
                        oninput="updateValue('terminalEntries', 'amount', { date: '${state.selectedDate}', terminalId: '${t.id}', shift: 'afternoon' }, this.value)"
                        class="w-full p-2 bg-emerald-50 border rounded-lg text-right font-bold text-emerald-600">
                </div>`;
            });
            html += `</div></div>`;

            // Reporte Final
            const totals = calculateTotals();
            html += `
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-indigo-100 cursor-pointer active:scale-95 transition-all mb-8" onclick="copyReport()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-black text-xl text-indigo-600 tracking-tighter">${formatDateSpanish(state.selectedDate)}</h2>
                    <i data-lucide="copy" class="text-indigo-300"></i>
                </div>
                <div class="space-y-3 border-b border-dashed pb-5 mb-5">
                    ${totals.branchDetails.map(b => `<div class="flex justify-between text-sm items-center"><span class="text-gray-500 font-medium">${b.name}</span><span class="font-bold">$ ${formatCurrency(b.total)}</span></div>`).join('')}
                    <div class="flex justify-between font-black text-lg text-indigo-600 pt-2">
                        <span>TOTAL VENTAS</span>
                        <span>$ ${formatCurrency(totals.totalGross)}</span>
                    </div>
                </div>
                <div class="space-y-1 mb-6">
                    <p class="text-[9px] font-black uppercase opacity-40 mb-2">Deducciones</p>
                    <div class="flex justify-between text-sm text-rose-500">
                        <span class="font-medium italic">Pagos y Gastos</span>
                        <span class="font-bold">-$ ${formatCurrency(totals.totalDeductions)}</span>
                    </div>
                </div>
                <div class="bg-indigo-600 p-6 rounded-3xl text-white text-center relative overflow-hidden shadow-lg shadow-indigo-200">
                    <p class="text-xs font-black uppercase opacity-70 mb-1">Efectivo Total a Entregar</p>
                    <p class="text-5xl font-black tracking-tighter">$ ${formatCurrency(totals.totalCash)}</p>
                    <i data-lucide="banknote" class="absolute -right-6 -bottom-6 opacity-10 rotate-12" style="width:120px; height:120px;"></i>
                </div>
                <p class="text-[10px] text-center mt-4 font-black text-indigo-400 uppercase tracking-widest animate-pulse">Toca para copiar resumen</p>
            </div>`;

            container.innerHTML = html;
        }

        function calculateTotals() {
            const dayClosures = state.closures.filter(x => x.date === state.selectedDate);
            const dayPmts = state.payments.filter(x => x.date === state.selectedDate);
            const dayExtras = state.extras.filter(x => x.date === state.selectedDate);
            const dayTerminals = state.terminalEntries.filter(x => x.date === state.selectedDate);

            const branchDetails = state.branches.filter(b => b.active).map(b => {
                const c = dayClosures.find(x => x.branchId === b.id);
                return { name: b.name, total: (c?.morning || 0) + (c?.afternoon || 0) };
            });

            const totalGross = branchDetails.reduce((a, b) => a + b.total, 0);
            const totalPmts = dayPmts.reduce((a, b) => a + b.amount, 0);
            const totalExtras = dayExtras.reduce((a, b) => a + b.amount, 0);
            const totalDeductions = totalPmts + totalExtras;
            const totalDay = totalGross - totalDeductions;
            const totalTerms = dayTerminals.reduce((a, b) => a + b.amount, 0);
            const totalCash = totalDay - totalTerms;

            return { branchDetails, totalGross, totalDeductions, totalDay, totalCash, dayPmts, dayExtras, dayTerminals };
        }

        function copyReport() {
            const t = calculateTotals();
            const dateStr = formatDateSpanish(state.selectedDate);
            
            const branchLines = t.branchDetails.map(b => `${b.name}: $${formatCurrency(b.total)}`).join('\n');
            const pmtLines = state.sellers.filter(s => s.active).map(s => {
                const amt = t.dayPmts.filter(x => x.sellerId === s.id).reduce((a, b) => a + b.amount, 0);
                return amt > 0 ? `- Pago ${s.name}: $${formatCurrency(amt)}` : '';
            }).filter(Boolean).join('\n');
            
            const extraLines = t.dayExtras.filter(e => e.amount > 0).map(e => `- ${e.description}: $${formatCurrency(e.amount)}`).join('\n');
            
            const terminalLines = state.terminals.filter(x => x.active).map(term => {
                const amt = t.dayTerminals.filter(x => x.terminalId === term.id).reduce((a, b) => a + b.amount, 0);
                return amt > 0 ? `- ${term.name}: $${formatCurrency(amt)}` : '';
            }).filter(Boolean).join('\n');

            const text = `${dateStr}

DETALLE SUCURSALES:
${branchLines}
TOTAL VENTAS: $${formatCurrency(t.totalGross)}

DEDUCCIONES:
${pmtLines}${pmtLines && extraLines ? '\n' : ''}${extraLines}
TOTAL DEDUCCIONES: $${formatCurrency(t.totalDeductions)}

*TOTAL DÍA: $${formatCurrency(t.totalDay)}*
${terminalLines ? terminalLines + '\n' : ''}TOTAL EFECTIVO: $${formatCurrency(t.totalCash)}`;

            navigator.clipboard.writeText(text).then(() => {
                alert('Resumen copiado al portapapeles');
            });
        }

        function renderSettingsView(container) {
            let html = `<div class="bg-white p-5 rounded-3xl shadow-sm border space-y-6">
                <h2 class="font-black text-lg flex items-center gap-2"><i data-lucide="settings"></i> Ajustes de Listas</h2>`;
            
            const sections = [
                { label: 'Vendedores', key: 'sellers' },
                { label: 'Sucursales', key: 'branches' },
                { label: 'Terminales', key: 'terminals' }
            ];

            sections.forEach(sec => {
                html += `<div class="space-y-2">
                    <div class="flex justify-between items-center border-b pb-1">
                        <span class="text-[10px] font-black uppercase opacity-40 tracking-widest">${sec.label}</span>
                        <button onclick="addItem('${sec.key}')" class="p-1 bg-indigo-600 text-white rounded-full"><i data-lucide="plus" size="14"></i></button>
                    </div>
                    <div class="space-y-2">`;
                
                state[sec.key].forEach(item => {
                    html += `
                    <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-xl border border-gray-100">
                        <input type="text" value="${item.name}" 
                            oninput="updateItemName('${sec.key}', '${item.id}', this.value)"
                            class="flex-1 bg-transparent text-xs font-bold outline-none">
                        <button onclick="toggleItem('${sec.key}', '${item.id}')" 
                            class="p-1.5 rounded-lg ${item.active ? 'text-indigo-600 bg-indigo-50' : 'text-gray-300'}">
                            <i data-lucide="${item.active ? 'eye' : 'eye-off'}" size="16"></i>
                        </button>
                    </div>`;
                });
                html += `</div></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function addItem(key) {
            const name = prompt('Nombre del nuevo registro:');
            if (name) {
                state[key].push({ id: Date.now().toString(), name, active: true });
                saveState();
                render();
            }
        }

        function updateItemName(key, id, val) {
            state[key] = state[key].map(x => x.id === id ? { ...x, name: val } : x);
            saveState();
        }

        function toggleItem(key, id) {
            state[key] = state[key].map(x => x.id === id ? { ...x, active: !x.active } : x);
            saveState();
            render();
        }

        // --- Init ---
        window.onload = () => {
            loadState();
            render();
        };

    </script>
</body>
</html>
