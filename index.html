import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Seller, Branch, Terminal, SaleEntry, PaymentEntry, BranchClosure, TerminalEntry, ExtraExpense, View, Theme } from './types';
import Navigation from './components/Navigation';
import { 
  Sun, Moon, Banknote, ClipboardCheck, LayoutDashboard, Settings, Plus, 
  Eye, EyeOff, Save, Download, Copy, Calendar, Upload, FileJson, 
  ArrowUp, ArrowDown, Camera, X, ChevronLeft, ChevronRight, Triangle, 
  Receipt, ShieldCheck, Palette, Percent, Calculator, TrendingUp, MessageSquareText 
} from 'lucide-react';

const App: React.FC = () => {
  const [view, setView] = useState<View>('morning');
  const [selectedDate, setSelectedDate] = useState<string>(new Date().toISOString().split('T')[0]);
  const [theme, setTheme] = useState<Theme>('indigo');
  const [isDarkMode, setIsDarkMode] = useState<boolean>(false);
  const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');
  
  const [sellers, setSellers] = useState<Seller[]>([]);
  const [branches, setBranches] = useState<Branch[]>([]);
  const [terminals, setTerminals] = useState<Terminal[]>([]);
  const [sales, setSales] = useState<SaleEntry[]>([]);
  const [payments, setPayments] = useState<PaymentEntry[]>([]);
  const [branchClosures, setBranchClosures] = useState<BranchClosure[]>([]);
  const [terminalEntries, setTerminalEntries] = useState<TerminalEntry[]>([]);
  const [extraExpenses, setExtraExpenses] = useState<ExtraExpense[]>([]);

  const [commissionModal, setCommissionModal] = useState({ show: false, sellerId: '', shift: 'morning' as 'morning' | 'afternoon', tempType: 'none' as SaleEntry['commissionType'], tempM20: 0, tempM25: 0 });
  const [conceptModal, setConceptModal] = useState({ show: false, type: 'gasto' as 'gasto' | 'garantia', tempDescription: '' });
  const [paymentCalcModal, setPaymentCalcModal] = useState({ 
    show: false, sellerId: '', 
    startDate: new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0], 
    endDate: new Date().toISOString().split('T')[0], 
    baseSalary: 0 
  });

  const photoInputRef = useRef<HTMLInputElement>(null);
  const [targetIdForPhoto, setTargetIdForPhoto] = useState<{id: string, type: 'seller' | 'branch' | 'terminal'} | null>(null);

  useEffect(() => {
    const data = localStorage.getItem('vendas_app_data');
    if (data) {
      const parsed = JSON.parse(data);
      setSellers(parsed.sellers || []);
      setBranches(parsed.branches || []);
      setTerminals(parsed.terminals || []);
      setSales(parsed.sales || []);
      setPayments(parsed.payments || []);
      setBranchClosures(parsed.branchClosures || []);
      setTerminalEntries(parsed.terminalEntries || []);
      setExtraExpenses(parsed.extraExpenses || []);
      if (parsed.theme) setTheme(parsed.theme);
      if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
    } else {
      setSellers([{ id: '1', name: 'Vendedor 1', active: true, order: 0 }]);
      setBranches([{ id: '1', name: 'Sucursal Central', active: true, order: 0 }]);
      setTerminals([{ id: '1', name: 'Terminal A', active: true, order: 0 }]);
    }
  }, []);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', isDarkMode);
  }, [isDarkMode]);

  const persistData = () => {
    try {
      const data = { sellers, branches, terminals, sales, payments, branchClosures, terminalEntries, extraExpenses, theme, isDarkMode };
      localStorage.setItem('vendas_app_data', JSON.stringify(data));
      setSaveStatus('success');
      setTimeout(() => setSaveStatus('idle'), 1500);
    } catch (e) {
      setSaveStatus('error');
      setTimeout(() => setSaveStatus('idle'), 1500);
    }
  };

  const activeSellers = useMemo(() => [...sellers].filter(s => s.active).sort((a, b) => a.order - b.order), [sellers]);
  const activeBranches = useMemo(() => [...branches].filter(b => b.active).sort((a, b) => a.order - b.order), [branches]);
  const activeTerminals = useMemo(() => [...terminals].filter(t => t.active).sort((a, b) => a.order - b.order), [terminals]);

  const themeColors = {
    indigo: { bg: 'bg-indigo-50', text: 'text-indigo-500', border: 'border-indigo-100', btn: 'bg-indigo-500 hover:bg-indigo-600', ring: 'ring-indigo-200', headerText: 'text-indigo-700', dot: 'bg-indigo-500' },
    emerald: { bg: 'bg-emerald-50', text: 'text-emerald-500', border: 'border-emerald-100', btn: 'bg-emerald-500 hover:bg-emerald-600', ring: 'ring-emerald-200', headerText: 'text-emerald-700', dot: 'bg-emerald-500' },
    rose: { bg: 'bg-rose-50', text: 'text-rose-500', border: 'border-rose-100', btn: 'bg-rose-500 hover:bg-rose-600', ring: 'ring-rose-200', headerText: 'text-rose-700', dot: 'bg-rose-500' },
    amber: { bg: 'bg-amber-50', text: 'text-amber-500', border: 'border-amber-100', btn: 'bg-amber-500 hover:bg-amber-600', ring: 'ring-amber-200', headerText: 'text-amber-700', dot: 'bg-amber-500' },
    slate: { bg: 'bg-slate-50', text: 'text-slate-500', border: 'border-slate-100', btn: 'bg-slate-500 hover:bg-slate-600', ring: 'ring-slate-200', headerText: 'text-slate-700', dot: 'bg-slate-500' },
  };

  const getThemeClass = (part: keyof typeof themeColors.indigo) => themeColors[theme][part];
  const baseBg = isDarkMode ? 'bg-gray-950' : 'bg-gray-50';
  const cardBg = isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-100';
  const inputBg = isDarkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-700';
  const labelText = isDarkMode ? 'text-gray-400' : 'text-gray-500';
  const mainText = isDarkMode ? 'text-gray-100' : 'text-gray-900';
  const subText = isDarkMode ? 'text-gray-500' : 'text-gray-400';
  const morningFieldBg = isDarkMode ? 'bg-yellow-400/20 border-yellow-500/30' : 'bg-yellow-50 border-yellow-100';
  const afternoonFieldBg = isDarkMode ? 'bg-blue-400/20 border-blue-500/30' : 'bg-blue-50 border-blue-100';

  const formatCurrency = (val: number) => Math.round(val).toLocaleString();

  const handleSaleChange = (sellerId: string, shift: 'morning' | 'afternoon', value: string) => {
    const amount = parseFloat(value) || 0;
    setSales(prev => {
      const filtered = prev.filter(s => !(s.date === selectedDate && s.sellerId === sellerId && s.shift === shift));
      const existing = prev.find(s => s.date === selectedDate && s.sellerId === sellerId && s.shift === shift);
      let entry: SaleEntry = { 
        date: selectedDate, sellerId, amount, shift, 
        commissionType: existing?.commissionType || 'none', 
        commission: 0,
        mixto20: existing?.mixto20,
        mixto25: existing?.mixto25
      };
      
      if (entry.commissionType === 'mixto') {
        entry.commission = (entry.mixto20 || 0) * 0.2 + (entry.mixto25 || 0) * 0.25;
      } else if (entry.commissionType !== 'none') {
        entry.commission = amount * (parseInt(entry.commissionType as string) / 100);
      }
      return [...filtered, entry];
    });
  };

  const saveCommission = () => {
    const { sellerId, shift, tempType, tempM20, tempM25 } = commissionModal;
    setSales(prev => {
      const filtered = prev.filter(s => !(s.date === selectedDate && s.sellerId === sellerId && s.shift === shift));
      const existing = prev.find(s => s.date === selectedDate && s.sellerId === sellerId && s.shift === shift);
      let amount = existing?.amount || 0;
      let commission = 0;
      if (tempType === 'mixto') {
        amount = tempM20 + tempM25;
        commission = (tempM20 * 0.2) + (tempM25 * 0.25);
      } else if (tempType !== 'none') {
        commission = amount * (parseInt(tempType as string) / 100);
      }
      return [...filtered, { 
        date: selectedDate, sellerId, amount, shift, 
        commissionType: tempType, commission, 
        mixto20: tempType === 'mixto' ? tempM20 : undefined, 
        mixto25: tempType === 'mixto' ? tempM25 : undefined 
      }];
    });
    setCommissionModal(prev => ({ ...prev, show: false }));
  };

  /* Fix for missing changeDate, handlePaymentChange, handleBranchClosureChange, openConceptModal, handleExtraExpenseChange, handleTerminalChange, and saveConcept */
  const changeDate = (offset: number) => {
    const date = new Date(selectedDate);
    date.setDate(date.getDate() + offset);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  const handlePaymentChange = (sellerId: string, shift: 'morning' | 'afternoon', value: string) => {
    const amount = parseFloat(value) || 0;
    setPayments(prev => {
      const filtered = prev.filter(p => !(p.date === selectedDate && p.sellerId === sellerId && p.shift === shift));
      return [...filtered, { date: selectedDate, sellerId, amount, shift }];
    });
  };

  const handleBranchClosureChange = (branchId: string, field: 'morningAmount' | 'afternoonAmount', value: string) => {
    const amount = parseFloat(value) || 0;
    setBranchClosures(prev => {
      const existing = prev.find(bc => bc.date === selectedDate && bc.branchId === branchId);
      const filtered = prev.filter(bc => !(bc.date === selectedDate && bc.branchId === branchId));
      const newItem = existing 
        ? { ...existing, [field]: amount } 
        : { date: selectedDate, branchId, morningAmount: 0, afternoonAmount: 0, [field]: amount };
      return [...filtered, newItem];
    });
  };

  const openConceptModal = (type: 'gasto' | 'garantia') => {
    const existing = extraExpenses.find(e => e.date === selectedDate && e.type === type);
    setConceptModal({ show: true, type, tempDescription: existing?.description || '' });
  };

  const saveConcept = () => {
    const { type, tempDescription } = conceptModal;
    setExtraExpenses(prev => {
      const hasEntries = prev.some(e => e.date === selectedDate && e.type === type);
      if (!hasEntries) {
        return [
          ...prev,
          { date: selectedDate, type, amount: 0, shift: 'morning', description: tempDescription },
          { date: selectedDate, type, amount: 0, shift: 'afternoon', description: tempDescription }
        ];
      }
      return prev.map(e => (e.date === selectedDate && e.type === type) ? { ...e, description: tempDescription } : e);
    });
    setConceptModal(prev => ({ ...prev, show: false }));
  };

  const handleExtraExpenseChange = (type: 'gasto' | 'garantia', shift: 'morning' | 'afternoon', value: string) => {
    const amount = parseFloat(value) || 0;
    setExtraExpenses(prev => {
      const filtered = prev.filter(e => !(e.date === selectedDate && e.type === type && e.shift === shift));
      const existing = prev.find(e => e.date === selectedDate && e.type === type);
      const description = existing?.description || '';
      return [...filtered, { date: selectedDate, type, amount, shift, description }];
    });
  };

  const handleTerminalChange = (terminalId: string, shift: 'morning' | 'afternoon', value: string) => {
    const amount = parseFloat(value) || 0;
    setTerminalEntries(prev => {
      const filtered = prev.filter(te => !(te.date === selectedDate && te.terminalId === terminalId && te.shift === shift));
      return [...filtered, { date: selectedDate, terminalId, amount, shift }];
    });
  };

  const summaryData = useMemo(() => {
    const dayClosures = branchClosures.filter(b => b.date === selectedDate);
    const dayPayments = payments.filter(p => p.date === selectedDate);
    const dayTerminals = terminalEntries.filter(t => t.date === selectedDate);
    const dayExtras = extraExpenses.filter(e => e.date === selectedDate);

    const detailByBranch = activeBranches.map(br => {
      const data = dayClosures.find(c => c.branchId === br.id);
      return { name: br.name, total: (data?.morningAmount || 0) + (data?.afternoonAmount || 0) };
    });

    const groupedPayments = dayPayments.reduce<Record<string, {name:string, amount:number}>>((acc, p) => {
      const seller = sellers.find(s => s.id === p.sellerId);
      const sellerName = seller ? seller.name : 'Vendedor';
      if (!acc[p.sellerId]) acc[p.sellerId] = { name: sellerName, amount: 0 };
      acc[p.sellerId].amount += p.amount;
      return acc;
    }, {});

    const paymentsBySeller = Object.values(groupedPayments).filter(p => p.amount > 0);
    const totalGross = detailByBranch.reduce((acc, b) => acc + b.total, 0);
    const totalPayments = dayPayments.reduce((acc, p) => acc + p.amount, 0);
    
    const groupedExtras = dayExtras.reduce<Record<string, {amount:number, type: 'gasto' | 'garantia'}>>((acc, e) => {
      const key = e.type === 'gasto' ? e.description : 'Garantía';
      if (!acc[key]) acc[key] = { amount: 0, type: e.type };
      acc[key].amount += e.amount;
      return acc;
    }, {});

    const totalGastos = dayExtras.filter(e => e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
    const totalGarantias = dayExtras.filter(e => e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
    const totalDeductions = totalPayments + totalGastos + totalGarantias;
    const totalDay = totalGross - totalDeductions;
    const totalTerminals = dayTerminals.reduce((acc, t) => acc + t.amount, 0);
    const totalCash = totalDay - totalTerminals;

    const morningBranchTotal = dayClosures.reduce((acc, b) => acc + b.morningAmount, 0);
    const morningTerminalTotal = dayTerminals.filter(t => t.shift === 'morning').reduce((acc, t) => acc + t.amount, 0);
    const morningGastoTotal = dayExtras.filter(e => e.shift === 'morning' && e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
    const morningGarantiaTotal = dayExtras.filter(e => e.shift === 'morning' && e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
    const morningPaymentTotal = dayPayments.filter(p => p.shift === 'morning').reduce((acc, p) => acc + p.amount, 0);
    const morningCashTotal = morningBranchTotal - morningTerminalTotal - morningGastoTotal - morningGarantiaTotal - morningPaymentTotal;

    const afternoonBranchTotal = dayClosures.reduce((acc, b) => acc + b.afternoonAmount, 0);
    const afternoonTerminalTotal = dayTerminals.filter(t => t.shift === 'afternoon').reduce((acc, t) => acc + t.amount, 0);
    const afternoonGastoTotal = dayExtras.filter(e => e.shift === 'afternoon' && e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
    const afternoonGarantiaTotal = dayExtras.filter(e => e.shift === 'afternoon' && e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
    const afternoonPaymentTotal = dayPayments.filter(p => p.shift === 'afternoon').reduce((acc, p) => acc + p.amount, 0);
    const afternoonCashTotal = afternoonBranchTotal - afternoonTerminalTotal - afternoonGastoTotal - afternoonGarantiaTotal - afternoonPaymentTotal;

    return { date: selectedDate, detailByBranch, paymentsBySeller, totalGross, totalPayments, totalGastos, totalGarantias, totalDeductions, totalDay, totalTerminals, totalCash, morningCashTotal, afternoonCashTotal, groupedExtras };
  }, [selectedDate, sales, branchClosures, payments, terminalEntries, extraExpenses, activeBranches, sellers]);

  const copySummaryText = () => {
    const formatDateSpanish = (dateStr: string) => {
      const [year, month, day] = dateStr.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      const weekday = date.toLocaleDateString('es-ES', { weekday: 'long' });
      const dayNum = date.toLocaleDateString('es-ES', { day: '2-digit' });
      const monthLabel = date.toLocaleDateString('es-ES', { month: 'long' });
      return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${dayNum} de ${monthLabel} ${year}`;
    };

    const terminalDetail = activeTerminals.map(t => {
      const amtM = terminalEntries.find(te => te.date === selectedDate && te.terminalId === t.id && te.shift === 'morning')?.amount || 0;
      const amtT = terminalEntries.find(te => te.date === selectedDate && te.terminalId === t.id && te.shift === 'afternoon')?.amount || 0;
      return amtM + amtT > 0 ? `- ${t.name}: $${formatCurrency(amtM + amtT)}` : '';
    }).filter(Boolean).join('\n');

    const deductionsLines = [
      ...summaryData.paymentsBySeller.map(p => `- ${p.name}: $${formatCurrency(p.amount)}`),
      ...Object.entries(summaryData.groupedExtras).map(([concept, data]) => {
        if (data.amount <= 0) return '';
        const label = data.type === 'gasto' ? concept : 'Garantía';
        return `${label}: $${formatCurrency(data.amount)}`;
      }).filter(Boolean)
    ];

    const deductionsListStr = deductionsLines.length > 0 ? deductionsLines.join('\n') : '';

    const text = `${formatDateSpanish(summaryData.date)}

DETALLE SUCURSALES:
${summaryData.detailByBranch.map(b => `${b.name}: $${formatCurrency(b.total)}`).join('\n')}
TOTAL VENTAS: $${formatCurrency(summaryData.totalGross)}

DEDUCCIONES:
${deductionsListStr}
TOTAL DEDUCCIONES: $${formatCurrency(summaryData.totalDeductions)}

*TOTAL DÍA: $${formatCurrency(summaryData.totalDay)}*
${terminalDetail ? terminalDetail + '\n' : ''}TOTAL EFECTIVO: $${formatCurrency(summaryData.totalCash)}`;
    
    navigator.clipboard.writeText(text);
    alert('Resumen copiado al portapapeles');
  };

  const VisualPreview = ({ source, size = "12", hasCalculated = false, onClick }: { source?: string, size?: string, hasCalculated?: boolean, onClick?: () => void }) => {
    const borderClass = hasCalculated ? 'ring-4 ring-emerald-500 ring-offset-2' : '';
    if (!source) return (
      <div onClick={onClick} className={`w-${size} h-${size} rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-white'} border border-gray-200 flex items-center justify-center text-gray-300 shadow-inner cursor-pointer transition-all ${borderClass}`}>
        <Camera size={20} />
      </div>
    );
    return (
      <img src={source} onClick={onClick} className={`w-${size} h-${size} rounded-xl object-cover border-2 border-white shadow-sm cursor-pointer transition-all ${borderClass}`} alt="Preview" />
    );
  };

  return (
    <div className={`min-h-screen pb-24 ${baseBg} flex flex-col transition-colors duration-500`}>
      <header className={`${getThemeClass('bg')} ${getThemeClass('headerText')} p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center transition-colors duration-300`}>
        <div className="flex items-center gap-3">
          <div onClick={persistData} className={`w-8 h-8 bg-white/60 rounded-lg flex items-center justify-center shadow-sm cursor-pointer transition-all active:scale-90 ${saveStatus !== 'idle' ? 'scale-125' : ''}`}>
            <Triangle size={20} fill="currentColor" className={`${saveStatus === 'success' ? 'text-lime-500' : saveStatus === 'error' ? 'text-red-600' : getThemeClass('text')}`} />
          </div>
          <h1 className="text-xl font-black tracking-tighter select-none pointer-events-none uppercase tracking-widest">TRIANGULO APP</h1>
        </div>
        <button onClick={() => setView(view === 'settings' ? 'morning' : 'settings')} className={`p-2 rounded-full transition-all ${view === 'settings' ? 'bg-white shadow-sm ' + getThemeClass('text') : 'bg-white/40'}`}>
          {view === 'settings' ? <X size={22} /> : <Settings size={22} />}
        </button>
      </header>

      <div className={`${isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-200'} border-b p-2 flex items-center justify-between sticky top-[64px] z-40 transition-colors`}>
        <button onClick={() => changeDate(-1)} className={`p-2 ${getThemeClass('text')}`}><ChevronLeft size={24} /></button>
        <div className={`flex items-center gap-2 ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-100'} px-4 py-2 rounded-xl border shadow-sm relative`}>
          <Calendar size={18} className={getThemeClass('text')} />
          <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className={`bg-transparent text-sm font-bold focus:outline-none border-none ${isDarkMode ? 'text-white' : 'text-gray-700'} cursor-pointer`} />
        </div>
        <button onClick={() => changeDate(1)} className={`p-2 ${getThemeClass('text')}`}><ChevronRight size={24} /></button>
      </div>

      <main className="flex-1 p-4 max-w-lg mx-auto w-full">
        {(view === 'morning' || view === 'afternoon') && (
          <div className="space-y-4 animate-in">
            <div className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
              <h2 className={`${labelText} text-xs font-black uppercase tracking-widest mb-4 border-b pb-2`}>Ventas {view === 'morning' ? 'Mañana' : 'Tarde'}</h2>
              <div className="space-y-3">
                {activeSellers.map(seller => {
                  const entry = sales.find(s => s.date === selectedDate && s.sellerId === seller.id && s.shift === view);
                  const hasCom = entry?.commissionType && entry.commissionType !== 'none';
                  return (
                    <div key={seller.id} className={`flex items-center justify-between gap-4 p-2 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-50'} rounded-xl border ${isDarkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                      <div className="flex items-center gap-3">
                        <VisualPreview source={seller.image} size="10" hasCalculated={hasCom} onClick={() => setCommissionModal({ show: true, sellerId: seller.id, shift: view, tempType: entry?.commissionType || 'none', tempM20: entry?.mixto20 || 0, tempM25: entry?.mixto25 || 0 })} />
                        <div className="flex flex-col">
                          <span className={`font-bold ${mainText} text-sm`}>{seller.name}</span>
                          {hasCom && <span className="text-[10px] font-black text-emerald-500 uppercase">Com: ${formatCurrency(entry!.commission || 0)}</span>}
                        </div>
                      </div>
                      <div className="relative">
                        <span className={`absolute left-3 top-1/2 -translate-y-1/2 ${getThemeClass('text')} font-bold opacity-60 text-xs`}>$</span>
                        <input type="number" value={entry?.amount || ''} onChange={(e) => handleSaleChange(seller.id, view, e.target.value)} className={`w-28 pl-7 pr-3 py-2 ${inputBg} rounded-lg text-right font-black shadow-inner outline-none focus:ring-2 ${getThemeClass('ring')}`} />
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {view === 'payments' && (
          <div className="space-y-4 animate-in">
            <div className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
              <h2 className={`${labelText} text-xs font-black uppercase tracking-widest mb-4 border-b pb-2`}>Pagos a Vendedores</h2>
              <div className="space-y-4">
                {activeSellers.map(seller => {
                  const amtM = payments.find(p => p.date === selectedDate && p.sellerId === seller.id && p.shift === 'morning')?.amount || 0;
                  const amtT = payments.find(p => p.date === selectedDate && p.sellerId === seller.id && p.shift === 'afternoon')?.amount || 0;
                  const isCalc = payments.some(p => p.date === selectedDate && p.sellerId === seller.id && p.calculated);
                  return (
                    <div key={seller.id} className={`p-3 rounded-xl border ${isDarkMode ? 'border-gray-800' : 'border-gray-50'} ${isDarkMode ? 'bg-gray-800/50' : 'bg-gray-50/50'}`}>
                      <div className="flex items-center gap-3 mb-3">
                        <VisualPreview source={seller.image} size="10" hasCalculated={isCalc} onClick={() => setPaymentCalcModal({ ...paymentCalcModal, show: true, sellerId: seller.id })} />
                        <span className={`font-bold ${mainText}`}>{seller.name}</span>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div className="space-y-1">
                          <span className="text-[9px] text-gray-400 font-bold ml-1 uppercase tracking-wider">Mañana</span>
                          <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-rose-300 font-bold text-xs">$</span><input type="number" value={amtM || ''} onChange={(e) => handlePaymentChange(seller.id, 'morning', e.target.value)} className={`w-full pl-6 pr-2 py-2 ${morningFieldBg} border border-rose-100 rounded-lg text-right font-black text-rose-600 outline-none`} /></div>
                        </div>
                        <div className="space-y-1">
                          <span className="text-[9px] text-gray-400 font-bold ml-1 uppercase tracking-wider">Tarde</span>
                          <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-rose-300 font-bold text-xs">$</span><input type="number" value={amtT || ''} onChange={(e) => handlePaymentChange(seller.id, 'afternoon', e.target.value)} className={`w-full pl-6 pr-2 py-2 ${afternoonFieldBg} border border-rose-100 rounded-lg text-right font-black text-rose-600 outline-none`} /></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {view === 'closure' && (
          <div className="space-y-4 animate-in pb-12">
            <h2 className={`text-xs font-black uppercase tracking-widest px-2 ${subText}`}>Cierre de Sucursales y Extras</h2>
            {activeBranches.map(branch => {
              const data = branchClosures.find(bc => bc.date === selectedDate && bc.branchId === branch.id) || { morningAmount: 0, afternoonAmount: 0 };
              return (
                <div key={branch.id} className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
                  <div className="flex items-center gap-3 mb-4"><VisualPreview source={branch.image} size="10" /><h3 className={`font-black ${getThemeClass('text')} uppercase tracking-tight`}>{branch.name}</h3></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1"><label className={`${labelText} text-[10px] uppercase font-black`}>Mañana</label><div className="relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 ${getThemeClass('text')} font-bold opacity-60 text-xs`}>$</span><input type="number" value={data.morningAmount || ''} onChange={(e) => handleBranchClosureChange(branch.id, 'morningAmount', e.target.value)} className={`w-full pl-7 pr-3 p-3 ${morningFieldBg} border rounded-xl font-black ${getThemeClass('text')} outline-none`} /></div></div>
                    <div className="space-y-1"><label className={`${labelText} text-[10px] uppercase font-black`}>Tarde</label><div className="relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 ${getThemeClass('text')} font-bold opacity-60 text-xs`}>$</span><input type="number" value={data.afternoonAmount || ''} onChange={(e) => handleBranchClosureChange(branch.id, 'afternoonAmount', e.target.value)} className={`w-full pl-7 pr-3 p-3 ${afternoonFieldBg} border rounded-xl font-black ${getThemeClass('text')} outline-none`} /></div></div>
                  </div>
                </div>
              );
            })}
            <div className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
              <h3 className={`${labelText} text-xs font-black uppercase mb-4 tracking-widest border-b pb-2`}>Gastos y Garantías</h3>
              <div className="space-y-6">
                {(['gasto', 'garantia'] as const).map(type => (
                  <div key={type}>
                    <div onClick={() => openConceptModal(type)} className="text-[10px] uppercase text-rose-400 font-black flex items-center gap-1 mb-2 cursor-pointer hover:underline p-1 -ml-1 rounded transition-colors hover:bg-rose-50 dark:hover:bg-rose-950/20 w-fit">
                      {type === 'gasto' ? <Receipt size={12} /> : <ShieldCheck size={12} />} <span>{type === 'gasto' ? 'Gastos' : 'Garantías'}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {(['morning', 'afternoon'] as const).map(sh => (
                        <div key={sh} className="space-y-1">
                          <span className="text-[9px] text-gray-400 font-bold ml-1 uppercase">{sh === 'morning' ? 'Mañana' : 'Tarde'}</span>
                          <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-rose-600 font-bold opacity-60 text-xs">$</span><input type="number" value={extraExpenses.find(e => e.date === selectedDate && e.type === type && e.shift === sh)?.amount || ''} onChange={(e) => handleExtraExpenseChange(type, sh, e.target.value)} className={`w-full pl-7 pr-3 p-3 ${sh === 'morning' ? morningFieldBg : afternoonFieldBg} border-rose-200 border rounded-xl font-black text-rose-600 outline-none`} /></div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <div className={`${cardBg} p-4 rounded-2xl shadow-sm border`}>
              <h3 className={`${labelText} text-xs font-black uppercase mb-4 tracking-widest`}>Terminales</h3>
              <div className="space-y-4">
                {activeTerminals.map(t => (
                  <div key={t.id} className={`p-3 rounded-xl border ${isDarkMode ? 'border-gray-800' : 'border-gray-50'} ${isDarkMode ? 'bg-gray-800/50' : 'bg-gray-50/50'}`}>
                    <div className="flex items-center gap-3 mb-2"><VisualPreview source={t.image} size="8" /><span className={`font-bold ${mainText}`}>{t.name}</span></div>
                    <div className="grid grid-cols-2 gap-3">
                      {(['morning', 'afternoon'] as const).map(sh => (
                        <div key={sh} className="space-y-1">
                          <span className="text-[9px] text-gray-400 font-bold ml-1 uppercase">{sh === 'morning' ? 'Mañana' : 'Tarde'}</span>
                          <div className="relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 ${getThemeClass('text')} font-bold opacity-60 text-xs`}>$</span><input type="number" value={terminalEntries.find(te => te.date === selectedDate && te.terminalId === t.id && te.shift === sh)?.amount || ''} onChange={(e) => handleTerminalChange(t.id, sh, e.target.value)} className={`w-full pl-7 pr-3 p-2 ${sh === 'morning' ? morningFieldBg : afternoonFieldBg} border rounded-lg text-right font-black ${getThemeClass('text')} outline-none`} /></div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {view === 'summary' && (
          <div className="space-y-4 animate-in">
            <div className={`${cardBg} p-6 rounded-3xl shadow-xl border overflow-hidden relative active:scale-[0.98] transition-all cursor-pointer`} onClick={copySummaryText}>
              <div className="flex justify-between items-center mb-6"><h2 className={`font-black text-2xl ${getThemeClass('text')} tracking-tighter`}>{summaryData.date}</h2></div>
              <div className="mb-6"><h3 className={`text-[10px] font-black uppercase ${subText} mb-3 border-b pb-1 tracking-widest`}>Ventas por Sucursal</h3>
                <div className="space-y-2">
                  {summaryData.detailByBranch.map((b, i) => (<div key={i} className={`flex justify-between text-sm py-1 border-b ${isDarkMode ? 'border-gray-800' : 'border-gray-50'}`}><span className={`font-medium ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{b.name}</span><span className={`font-black ${getThemeClass('text')}`}>$ {formatCurrency(b.total)}</span></div>))}
                  <div className={`flex justify-between font-black text-lg pt-2 ${getThemeClass('text')}`}><span>TOTAL VENTAS</span><span>$ {formatCurrency(summaryData.totalGross)}</span></div>
                </div>
              </div>
              <div className={`mb-8 pt-4 border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-100'}`}>
                <h3 className={`text-[10px] font-black uppercase ${subText} mb-2 tracking-widest`}>Deducciones</h3>
                <div className="space-y-1">
                  {summaryData.paymentsBySeller.map((p, i) => (<div key={i} className="flex justify-between text-xs pl-2"><span className={`${isDarkMode ? 'text-gray-500' : 'text-gray-500'} italic`}>{p.name}</span><span className="font-bold text-rose-500">-$ {formatCurrency(p.amount)}</span></div>))}
                  {Object.entries(summaryData.groupedExtras).map(([concept, data]) => {
                    if (data.amount <= 0) return null;
                    const label = data.type === 'gasto' ? concept : 'Garantía';
                    return (<div key={concept} className="flex justify-between text-sm pl-2"><span className="font-medium">{label}:</span><span className="font-black text-rose-500">-$ {formatCurrency(data.amount)}</span></div>);
                  })}
                  <div className={`flex justify-between text-sm pt-2 border-t ${getThemeClass('border')} font-black mt-1`}><span>TOTAL DEDUCCIONES</span><span className="text-rose-500">-$ {formatCurrency(summaryData.totalDeductions)}</span></div>
                </div>
                <div className={`flex justify-between text-lg pt-4 border-t ${getThemeClass('border')} mt-3`}><span className="font-black uppercase tracking-tight">TOTAL DÍA</span><span className="font-black">$ {formatCurrency(summaryData.totalDay)}</span></div>
                <div className="flex justify-between text-sm pt-2"><span className="font-medium text-[10px] opacity-70">Cobro Terminales:</span><span className="font-black text-emerald-600">-$ {formatCurrency(summaryData.totalTerminals)}</span></div>
              </div>
              <div className={`${getThemeClass('bg')} ${getThemeClass('headerText')} p-6 rounded-2xl shadow-lg border-2 ${getThemeClass('border')} relative overflow-hidden text-center`}>
                <p className="text-xs uppercase font-black opacity-60 mb-1">Efectivo Total a Entregar</p>
                <p className="text-5xl font-black">$ {formatCurrency(summaryData.totalCash)}</p>
                <Banknote size={100} className="absolute -right-4 -bottom-4 opacity-10 rotate-12" />
              </div>
            </div>
          </div>
        )}

        {view === 'settings' && (
          <div className="space-y-6 animate-in">
             <div className={`${cardBg} p-5 rounded-2xl shadow-sm border`}>
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2"><Palette size={20} className={getThemeClass('text')} /><h2 className={`font-black ${mainText} text-lg tracking-tight`}>Personalización</h2></div>
                  <button onClick={() => setIsDarkMode(!isDarkMode)} className={`flex items-center gap-2 p-2 px-3 rounded-xl border transition-all ${isDarkMode ? 'bg-gray-800 border-gray-700 text-amber-300' : 'bg-gray-50 border-gray-200 text-indigo-500'}`}>{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}<span className="text-[10px] font-black uppercase">{isDarkMode ? 'Modo Luz' : 'Oscuro'}</span></button>
                </div>
                <div className="flex justify-between gap-2">{(['indigo', 'emerald', 'rose', 'amber', 'slate'] as Theme[]).map(t => (<button key={t} onClick={() => { setTheme(t); }} className={`w-10 h-10 rounded-full border-2 transition-all ${theme === t ? 'ring-2 ring-offset-2 ring-gray-400 scale-110 shadow-md' : 'border-transparent'} ${themeColors[t].dot}`} />))}</div>
             </div>
             
             {[{ label: 'Vendedores', type: 'seller' as const, items: sellers }, { label: 'Sucursales', type: 'branch' as const, items: branches }, { label: 'Terminales', type: 'terminal' as const, items: terminals }].map(section => (
               <div key={section.type} className={`${cardBg} p-5 rounded-2xl shadow-sm border`}>
                 <div className="flex justify-between items-center mb-5"><h2 className={`font-black ${mainText} text-xl tracking-tight`}>{section.label}</h2><button onClick={() => {
                   const newId = Date.now().toString();
                   const newItem = { id: newId, name: `Nuevo ${section.label}`, active: true, order: section.items.length };
                   if (section.type === 'seller') setSellers([...sellers, newItem as Seller]);
                   else if (section.type === 'branch') setBranches([...branches, newItem as Branch]);
                   else setTerminals([...terminals, newItem as Terminal]);
                 }} className={`p-2 px-4 ${getThemeClass('btn')} text-white rounded-full text-xs font-black shadow-sm`}>+ AÑADIR</button></div>
                 <div className="space-y-3">
                   {section.items.map((item) => (
                     <div key={item.id} className={`flex items-center justify-between p-3 rounded-xl border shadow-sm ${item.active ? (isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-100') : 'bg-gray-200 opacity-70'}`}>
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                          <div className="relative cursor-pointer" onClick={() => { setTargetIdForPhoto({ id: item.id, type: section.type }); photoInputRef.current?.click(); }}>
                            <VisualPreview source={item.image} size="10" />
                            <div className="absolute -bottom-1 -right-1 p-1 bg-white rounded-full shadow-sm border border-gray-100 text-gray-500"><Camera size={10} /></div>
                          </div>
                          <input type="text" value={item.name} onChange={(e) => {
                            const newName = e.target.value;
                            if (section.type === 'seller') setSellers(prev => prev.map(s => s.id === item.id ? { ...s, name: newName } : s));
                            else if (section.type === 'branch') setBranches(prev => prev.map(b => b.id === item.id ? { ...b, name: newName } : b));
                            else setTerminals(prev => prev.map(t => t.id === item.id ? { ...t, name: newName } : t));
                          }} className={`font-black text-sm bg-transparent border-none focus:ring-0 w-full outline-none ${item.active ? (isDarkMode ? 'text-white' : 'text-gray-800') : 'text-gray-500 line-through'}`} />
                        </div>
                        <button onClick={() => {
                          if (section.type === 'seller') setSellers(prev => prev.map(s => s.id === item.id ? {...s, active: !s.active} : s));
                          else if (section.type === 'branch') setBranches(prev => prev.map(b => b.id === item.id ? {...b, active: !b.active} : b));
                          else setTerminals(prev => prev.map(t => t.id === item.id ? {...t, active: !t.active} : t));
                        }} className={`p-3 rounded-xl ${item.active ? 'text-emerald-400' : 'text-gray-400'}`}>{item.active ? <Eye size={20} /> : <EyeOff size={20} />}</button>
                     </div>
                   ))}
                 </div>
               </div>
             ))}
          </div>
        )}
      </main>

      <Navigation currentView={view} setView={setView} theme={theme} />

      {/* Concept Edit Modal */}
      {conceptModal.show && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
          <div className={`${cardBg} w-full max-sm rounded-3xl shadow-2xl overflow-hidden border`}>
            <div className={`${getThemeClass('bg')} p-6 flex justify-between items-center border-b ${getThemeClass('border')}`}>
              <div className="flex items-center gap-2"><MessageSquareText size={20} className={getThemeClass('text')} /><h3 className={`font-black ${getThemeClass('text')} uppercase`}>Capturar Concepto</h3></div>
              <button onClick={() => setConceptModal(prev => ({ ...prev, show: false }))}><X size={24} className={getThemeClass('text')} /></button>
            </div>
            <div className="p-6 space-y-4">
              <label className={`${labelText} text-[10px] font-black uppercase tracking-widest`}>Descripción del {conceptModal.type === 'gasto' ? 'Gasto' : 'Garantía'}</label>
              <textarea value={conceptModal.tempDescription} onChange={(e) => setConceptModal(prev => ({ ...prev, tempDescription: e.target.value }))} className={`w-full p-4 h-32 ${inputBg} border rounded-2xl font-medium text-sm outline-none focus:ring-2 ${getThemeClass('ring')} resize-none`} autoFocus />
              <button onClick={saveConcept} className={`w-full py-4 rounded-2xl ${getThemeClass('btn')} text-white font-black uppercase text-sm shadow-xl flex items-center justify-center gap-2`}><Save size={18} /> GUARDAR CONCEPTO</button>
            </div>
          </div>
        </div>
      )}

      {/* Commission Modal */}
      {commissionModal.show && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
          <div className={`${cardBg} w-full max-sm rounded-3xl shadow-2xl overflow-hidden border`}>
            <div className={`${getThemeClass('bg')} p-6 flex justify-between items-center border-b ${getThemeClass('border')}`}>
              <div className="flex items-center gap-2"><Percent size={20} className={getThemeClass('text')} /><h3 className={`font-black ${getThemeClass('text')} uppercase`}>Comisión</h3></div>
              <button onClick={() => setCommissionModal(prev => ({ ...prev, show: false }))}><X size={24} className={getThemeClass('text')} /></button>
            </div>
            <div className="p-6 space-y-6">
              <div className="flex flex-wrap gap-2">
                {(['10', '20', '25', 'mixto', 'none'] as const).map(type => (
                  <button key={type} onClick={() => setCommissionModal(prev => ({ ...prev, tempType: type }))} className={`flex-1 py-3 px-1 rounded-xl font-black text-[10px] uppercase transition-all ${commissionModal.tempType === type ? `${getThemeClass('btn')} text-white shadow-lg` : isDarkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
                    {type === 'mixto' ? 'Mixto' : type === 'none' ? 'Sin Com' : `${type}%`}
                  </button>
                ))}
              </div>
              {commissionModal.tempType === 'mixto' && (
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1"><label className={`${labelText} text-[10px] font-black uppercase`}>Al 20%</label><input type="number" value={commissionModal.tempM20 || ''} onChange={(e) => setCommissionModal(prev => ({ ...prev, tempM20: parseFloat(e.target.value) || 0 }))} className={`w-full p-3 ${inputBg} border rounded-xl font-black text-sm outline-none`} /></div>
                  <div className="space-y-1"><label className={`${labelText} text-[10px] font-black uppercase`}>Al 25%</label><input type="number" value={commissionModal.tempM25 || ''} onChange={(e) => setCommissionModal(prev => ({ ...prev, tempM25: parseFloat(e.target.value) || 0 }))} className={`w-full p-3 ${inputBg} border rounded-xl font-black text-sm outline-none`} /></div>
                </div>
              )}
              <div className="p-5 rounded-2xl border border-emerald-500/20 text-center">
                <p className="text-emerald-600 text-[10px] font-black uppercase mb-1">Cifra Informativa</p>
                <p className="text-4xl font-black text-emerald-600">
                  $ {formatCurrency(
                    commissionModal.tempType === 'mixto' ? (commissionModal.tempM20 * 0.2 + commissionModal.tempM25 * 0.25) :
                    commissionModal.tempType === 'none' ? 0 : 
                    ((sales.find(s => s.date === selectedDate && s.sellerId === commissionModal.sellerId && s.shift === commissionModal.shift)?.amount || 0) * (parseInt(commissionModal.tempType as string) / 100))
                  )}
                </p>
              </div>
              <button onClick={saveCommission} className={`w-full py-4 rounded-2xl ${getThemeClass('btn')} text-white font-black uppercase text-sm shadow-xl flex items-center justify-center gap-2`}><Save size={18} /> GUARDAR COMISIÓN</button>
            </div>
          </div>
        </div>
      )}

      {/* Payment Calculator Modal */}
      {paymentCalcModal.show && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
          <div className={`${cardBg} w-full max-sm rounded-3xl shadow-2xl overflow-hidden border flex flex-col max-h-[90vh]`}>
            <div className={`${getThemeClass('bg')} p-6 flex justify-between items-center border-b ${getThemeClass('border')}`}>
              <div className="flex items-center gap-2"><Calculator size={20} className={getThemeClass('text')} /><h3 className={`font-black ${getThemeClass('text')} uppercase`}>Cálculo de Pago</h3></div>
              <button onClick={() => setPaymentCalcModal(prev => ({ ...prev, show: false }))}><X size={24} className={getThemeClass('text')} /></button>
            </div>
            <div className="p-6 space-y-5 overflow-y-auto custom-scrollbar">
              <div className="grid grid-cols-2 gap-3">
                <div className="space-y-1"><label className={`${labelText} text-[10px] font-black uppercase`}>Desde</label><input type="date" value={paymentCalcModal.startDate} onChange={(e) => setPaymentCalcModal({ ...paymentCalcModal, startDate: e.target.value })} className={`w-full px-3 py-2 ${inputBg} border rounded-xl text-xs font-bold`} /></div>
                <div className="space-y-1"><label className={`${labelText} text-[10px] font-black uppercase`}>Hasta</label><input type="date" value={paymentCalcModal.endDate} onChange={(e) => setPaymentCalcModal({ ...paymentCalcModal, endDate: e.target.value })} className={`w-full px-3 py-2 ${inputBg} border rounded-xl text-xs font-bold`} /></div>
              </div>
              <div className="space-y-2">
                <label className={`${labelText} text-[10px] font-black uppercase flex items-center gap-1`}><TrendingUp size={12} /> Desglose Comisiones</label>
                <div className={`max-h-32 overflow-y-auto rounded-xl border ${isDarkMode ? 'bg-gray-800/30 border-gray-700' : 'bg-gray-50 border-gray-100'} p-2 space-y-1 custom-scrollbar`}>
                  {sales.filter(s => s.sellerId === paymentCalcModal.sellerId && s.date >= paymentCalcModal.startDate && s.date <= paymentCalcModal.endDate && (s.commission || 0) > 0).map((s, idx) => (
                    <div key={idx} className={`flex justify-between items-center text-[10px] p-2 rounded-lg ${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
                      <span>{s.date} <span className="opacity-50">{s.shift === 'morning' ? 'M' : 'T'}</span></span>
                      <span className="font-black text-emerald-500">$ {formatCurrency(s.commission || 0)}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className="space-y-1">
                <label className={`${labelText} text-[10px] font-black uppercase`}>Salario Base</label>
                <input type="number" value={paymentCalcModal.baseSalary || ''} onChange={(e) => setPaymentCalcModal({ ...paymentCalcModal, baseSalary: parseFloat(e.target.value) || 0 })} placeholder="0" className={`w-full p-3 ${inputBg} border rounded-xl font-black shadow-inner outline-none`} />
              </div>
              {(() => {
                const coms = sales.filter(s => s.sellerId === paymentCalcModal.sellerId && s.date >= paymentCalcModal.startDate && s.date <= paymentCalcModal.endDate).reduce((acc, c) => acc + (c.commission || 0), 0);
                const prev = payments.filter(p => p.sellerId === paymentCalcModal.sellerId && p.date >= paymentCalcModal.startDate && p.date <= paymentCalcModal.endDate).reduce((acc, c) => acc + c.amount, 0);
                const total = coms + paymentCalcModal.baseSalary - prev;
                return (
                  <div className="p-5 rounded-2xl bg-indigo-500 text-white shadow-xl text-center space-y-4">
                    <div><p className="text-[10px] font-black uppercase opacity-60 mb-1">Total a Cobrar</p><p className="text-4xl font-black">$ {formatCurrency(total)}</p></div>
                    <div className="grid grid-cols-2 gap-2">
                      <button onClick={() => {
                        setPayments(prevArr => [...prevArr.filter(p => !(p.date === selectedDate && p.sellerId === paymentCalcModal.sellerId && p.shift === 'morning')), { date: selectedDate, sellerId: paymentCalcModal.sellerId, amount: Math.ceil(total), shift: 'morning', calculated: true }]);
                        setPaymentCalcModal({ ...paymentCalcModal, show: false });
                      }} className="py-2 px-1 bg-white/20 hover:bg-white/30 rounded-xl font-black text-[9px] uppercase transition-all">Aplicar Mañana</button>
                      <button onClick={() => {
                        setPayments(prevArr => [...prevArr.filter(p => !(p.date === selectedDate && p.sellerId === paymentCalcModal.sellerId && p.shift === 'afternoon')), { date: selectedDate, sellerId: paymentCalcModal.sellerId, amount: Math.ceil(total), shift: 'afternoon', calculated: true }]);
                        setPaymentCalcModal({ ...paymentCalcModal, show: false });
                      }} className="py-2 px-1 bg-white/20 hover:bg-white/30 rounded-xl font-black text-[9px] uppercase transition-all">Aplicar Tarde</button>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        </div>
      )}

      <input type="file" ref={photoInputRef} onChange={async (e) => {
        const file = e.target.files?.[0];
        if (!file || !targetIdForPhoto) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = 120 / img.width;
            canvas.width = 120; canvas.height = img.height * scale;
            canvas.getContext('2d')?.drawImage(img, 0, 0, canvas.width, canvas.height);
            const base64 = canvas.toDataURL('image/jpeg', 0.6);
            const { id, type } = targetIdForPhoto;
            if (type === 'seller') setSellers(prev => prev.map(s => s.id === id ? { ...s, image: base64 } : s));
            else if (type === 'branch') setBranches(prev => prev.map(b => b.id === id ? { ...b, image: base64 } : b));
            else if (type === 'terminal') setTerminals(prev => prev.map(t => t.id === id ? { ...t, image: base64 } : t));
            setTargetIdForPhoto(null);
          };
          img.src = ev.target?.result as string;
        };
        reader.readAsDataURL(file);
      }} accept="image/*" className="hidden" />
    </div>
  );
};

export default App;
