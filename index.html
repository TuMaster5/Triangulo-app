<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIANGULO APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .animate-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .active-scale:active { transform: scale(0.95); }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-500 min-h-screen flex flex-col">
    <div id="root" class="flex flex-col min-h-screen"></div>

    <script>
        // --- ESTADO GLOBAL ---
        let state = {
            view: 'morning',
            selectedDate: new Date().toISOString().split('T')[0],
            theme: 'indigo',
            isDarkMode: false,
            saveStatus: 'idle',
            sellers: [],
            branches: [],
            terminals: [],
            sales: [],
            payments: [],
            branchClosures: [],
            terminalEntries: [],
            extraExpenses: [],
            // Estados de Modales
            modals: {
                commission: { show: false, sellerId: '', shift: '', tempType: 'none', tempM20: 0, tempM25: 0 },
                concept: { show: false, type: 'gasto', tempDescription: '' },
                paymentCalc: { show: false, sellerId: '', startDate: '', endDate: '', baseSalary: 0 }
            }
        };

        // --- ICONOS SVG (Lucide) ---
        const ICONS = {
            sun: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>`,
            moon: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            banknote: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>`,
            clipboard: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>`,
            dashboard: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
            settings: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            plus: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5v14"/></svg>`,
            eye: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
            eyeOff: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61L2 22l20-20"/></svg>`,
            save: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            download: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>`,
            calendar: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            upload: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`,
            arrowUp: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 7-7 7 7M12 19V5"/></svg>`,
            arrowDown: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="m19 12-7 7-7-7M12 5v14"/></svg>`,
            camera: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>`,
            close: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>`,
            chevronLeft: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            chevronRight: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6 6-6"/></svg>`,
            triangle: `<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>`,
            receipt: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1z"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8M12 17.5V6.5"/></svg>`,
            shieldCheck: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1v7z"/><path d="m9 12 2 2 4-4"/></svg>`,
            palette: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.991 6.418 17.501 2 12 2z"/></svg>`,
            percent: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>`,
            calculator: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01M12 10h.01M8 10h.01M12 14h.01M8 14h.01M12 18h.01M8 18h.01"/></svg>`,
            history: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5M12 7v5l4 2"/></svg>`,
            trendingUp: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            messageSquare: `<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`
        };

        const themeColors = {
            indigo: { bg: 'bg-indigo-50', text: 'text-indigo-500', border: 'border-indigo-100', btn: 'bg-indigo-500 hover:bg-indigo-600', ring: 'ring-indigo-200', headerText: 'text-indigo-700', dot: 'bg-indigo-500' },
            emerald: { bg: 'bg-emerald-50', text: 'text-emerald-500', border: 'border-emerald-100', btn: 'bg-emerald-500 hover:bg-emerald-600', ring: 'ring-emerald-200', headerText: 'text-emerald-700', dot: 'bg-emerald-500' },
            rose: { bg: 'bg-rose-50', text: 'text-rose-500', border: 'border-rose-100', btn: 'bg-rose-500 hover:bg-rose-600', ring: 'ring-rose-200', headerText: 'text-rose-700', dot: 'bg-rose-500' },
            amber: { bg: 'bg-amber-50', text: 'text-amber-500', border: 'border-amber-100', btn: 'bg-amber-500 hover:bg-amber-600', ring: 'ring-amber-200', headerText: 'text-amber-700', dot: 'bg-amber-500' },
            slate: { bg: 'bg-slate-50', text: 'text-slate-500', border: 'border-slate-100', btn: 'bg-slate-500 hover:bg-slate-600', ring: 'ring-slate-200', headerText: 'text-slate-700', dot: 'bg-slate-500' },
        };

        // --- FUNCIONES DE PERSISTENCIA Y UTILIDAD ---
        function loadData() {
            const raw = localStorage.getItem('vendas_app_data');
            if (raw) {
                const parsed = JSON.parse(raw);
                state = { ...state, ...parsed };
            } else {
                state.sellers = [
                    { id: '1', name: 'Vendedor 1', active: true, order: 0 },
                    { id: '2', name: 'Vendedor 2', active: true, order: 1 }
                ];
                state.branches = [
                    { id: '1', name: 'Sucursal Central', active: true, order: 0 },
                    { id: 'v', name: 'Virtual', active: true, order: 1 }
                ];
                state.terminals = [{ id: '1', name: 'Terminal A', active: true, order: 0 }];
            }
        }

        function save() {
            localStorage.setItem('vendas_app_data', JSON.stringify(state));
            state.saveStatus = 'success';
            render();
            setTimeout(() => { state.saveStatus = 'idle'; render(); }, 1500);
        }

        const formatC = (val) => Math.round(val || 0).toLocaleString('en-US');
        const getTC = (part) => themeColors[state.theme][part];
        const getBaseBg = () => state.isDarkMode ? 'bg-gray-950' : 'bg-gray-50';
        const getCardBg = () => state.isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-100';
        const getInputBg = () => state.isDarkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-700';

        function formatDateSpanish(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const weekday = date.toLocaleDateString('es-ES', { weekday: 'long' });
            const dayNum = date.toLocaleDateString('es-ES', { day: '2-digit' });
            const monthLabel = date.toLocaleDateString('es-ES', { month: 'long' });
            return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${dayNum} de ${monthLabel} ${year}`;
        }

        // --- CÁLCULOS CENTRALIZADOS ---
        function getSaleAmount(id, shift) {
            return state.sales.find(s => s.date === state.selectedDate && s.sellerId === id && s.shift === shift)?.amount || 0;
        }

        function getSaleEntry(id, shift) {
            return state.sales.find(s => s.date === state.selectedDate && s.sellerId === id && s.shift === shift);
        }

        function getPaymentAmount(id, shift) {
            return state.payments.find(p => p.date === state.selectedDate && p.sellerId === id && p.shift === shift)?.amount || 0;
        }

        function getTerminalAmount(id, shift) {
            return state.terminalEntries.find(t => t.date === state.selectedDate && t.terminalId === id && t.shift === shift)?.amount || 0;
        }

        function getExtraAmount(type, shift) {
            return state.extraExpenses.find(e => e.date === state.selectedDate && e.type === type && e.shift === shift)?.amount || 0;
        }

        function calculateSummary() {
            const dayClosures = state.branchClosures.filter(b => b.date === state.selectedDate);
            const dayPayments = state.payments.filter(p => p.date === state.selectedDate);
            const dayTerminals = state.terminalEntries.filter(t => t.date === state.selectedDate);
            const dayExtras = state.extraExpenses.filter(e => e.date === state.selectedDate);

            const detailByBranch = state.branches.filter(b => b.active).map(br => {
                const data = dayClosures.find(c => c.branchId === br.id);
                return { name: br.name, total: (data?.morningAmount || 0) + (data?.afternoonAmount || 0) };
            });

            const groupedPayments = dayPayments.reduce((acc, p) => {
                const seller = state.sellers.find(s => s.id === p.sellerId);
                const name = seller ? seller.name : 'Desconocido';
                if (!acc[p.sellerId]) acc[p.sellerId] = { name, amount: 0 };
                acc[p.sellerId].amount += p.amount;
                return acc;
            }, {});

            const totalGross = detailByBranch.reduce((acc, b) => acc + b.total, 0);
            const totalPayments = dayPayments.reduce((acc, p) => acc + p.amount, 0);
            const totalGastos = dayExtras.filter(e => e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
            const totalGarantias = dayExtras.filter(e => e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
            const totalDeductions = totalPayments + totalGastos + totalGarantias;
            const totalDay = totalGross - totalDeductions;
            const totalTerminals = dayTerminals.reduce((acc, t) => acc + t.amount, 0);
            const totalCash = totalDay - totalTerminals;

            // Cash Breakdown for Informatory View
            const morningBranchT = dayClosures.reduce((acc, b) => acc + b.morningAmount, 0);
            const morningTermT = dayTerminals.filter(t => t.shift === 'morning').reduce((acc, t) => acc + t.amount, 0);
            const morningGastoT = dayExtras.filter(e => e.shift === 'morning' && e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
            const morningGarantiaT = dayExtras.filter(e => e.shift === 'morning' && e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
            const morningPmtT = dayPayments.filter(p => p.shift === 'morning').reduce((acc, p) => acc + p.amount, 0);
            const morningCash = morningBranchT - morningTermT - morningGastoT - morningGarantiaT - morningPmtT;

            const afternoonBranchT = dayClosures.reduce((acc, b) => acc + b.afternoonAmount, 0);
            const afternoonTermT = dayTerminals.filter(t => t.shift === 'afternoon').reduce((acc, t) => acc + t.amount, 0);
            const afternoonGastoT = dayExtras.filter(e => e.shift === 'afternoon' && e.type === 'gasto').reduce((acc, e) => acc + e.amount, 0);
            const afternoonGarantiaT = dayExtras.filter(e => e.shift === 'afternoon' && e.type === 'garantia').reduce((acc, e) => acc + e.amount, 0);
            const afternoonPmtT = dayPayments.filter(p => p.shift === 'afternoon').reduce((acc, p) => acc + p.amount, 0);
            const afternoonCash = afternoonBranchT - afternoonTermT - afternoonGastoT - afternoonGarantiaT - afternoonPmtT;

            return {
                detailByBranch, totalGross, groupedPayments: Object.values(groupedPayments).filter(p => p.amount > 0),
                totalDeductions, totalDay, totalTerminals, totalCash, morningCash, afternoonCash,
                groupedExtras: dayExtras.reduce((acc, e) => {
                    const key = e.type === 'gasto' ? e.description : 'Garantía';
                    if (!acc[key]) acc[key] = { amount: 0, type: e.type };
                    acc[key].amount += e.amount;
                    return acc;
                }, {})
            };
        }

        // --- HANDLERS ---
        function changeDate(days) {
            const d = new Date(state.selectedDate + 'T12:00:00');
            d.setDate(d.getDate() + days);
            state.selectedDate = d.toISOString().split('T')[0];
            save();
        }

        function updateSale(sellerId, shift, value) {
            const amount = parseFloat(value) || 0;
            const existing = state.sales.find(s => s.date === state.selectedDate && s.sellerId === sellerId && s.shift === shift);
            state.sales = state.sales.filter(s => !(s.date === state.selectedDate && s.sellerId === sellerId && s.shift === shift));
            
            let commission = 0;
            let type = existing?.commissionType || 'none';
            if (['10', '20', '25'].includes(type)) commission = amount * (parseFloat(type) / 100);
            else if (type === 'mixto') commission = (existing.mixto20 * 0.20) + (existing.mixto25 * 0.25);

            state.sales.push({ 
                date: state.selectedDate, sellerId, shift, amount, 
                commissionType: type, commission,
                mixto20: existing?.mixto20, mixto25: existing?.mixto25 
            });
            save();
        }

        function updatePayment(sellerId, shift, value) {
            const amount = parseFloat(value) || 0;
            state.payments = state.payments.filter(p => !(p.date === state.selectedDate && p.sellerId === sellerId && p.shift === shift));
            state.payments.push({ date: state.selectedDate, sellerId, shift, amount, calculated: false });
            save();
        }

        function updateBranchClosure(branchId, field, value) {
            const amount = parseFloat(value) || 0;
            let existing = state.branchClosures.find(b => b.date === state.selectedDate && b.branchId === branchId);
            state.branchClosures = state.branchClosures.filter(b => !(b.date === state.selectedDate && b.branchId === branchId));
            if (!existing) existing = { date: state.selectedDate, branchId, morningAmount: 0, afternoonAmount: 0 };
            existing[field] = amount;
            state.branchClosures.push(existing);
            save();
        }

        function updateExtra(type, shift, value) {
            const amount = parseFloat(value) || 0;
            const entries = state.extraExpenses.filter(e => e.date === state.selectedDate && e.type === type);
            const desc = entries.length > 0 ? entries[0].description : (type === 'gasto' ? 'Gasto' : 'Garantía');
            state.extraExpenses = state.extraExpenses.filter(e => !(e.date === state.selectedDate && e.type === type && e.shift === shift));
            state.extraExpenses.push({ date: state.selectedDate, type, shift, amount, description: desc });
            save();
        }

        function updateTerminal(id, shift, value) {
            const amount = parseFloat(value) || 0;
            state.terminalEntries = state.terminalEntries.filter(t => !(t.date === state.selectedDate && t.terminalId === id && t.shift === shift));
            state.terminalEntries.push({ date: state.selectedDate, terminalId: id, shift, amount });
            save();
        }

        // MODAL COMMISSIONS
        function openCommission(id, shift) {
            const entry = getSaleEntry(id, shift);
            state.modals.commission = { 
                show: true, sellerId: id, shift, 
                tempType: entry?.commissionType || 'none', 
                tempM20: entry?.mixto20 || 0, tempM25: entry?.mixto25 || 0 
            };
            render();
        }

        function saveCommission() {
            const { sellerId, shift, tempType, tempM20, tempM25 } = state.modals.commission;
            const entry = getSaleEntry(sellerId, shift);
            let amount = entry?.amount || 0;
            let commission = 0;

            if (tempType === '10') commission = amount * 0.10;
            else if (tempType === '20') commission = amount * 0.20;
            else if (tempType === '25') commission = amount * 0.25;
            else if (tempType === 'mixto') {
                commission = (tempM20 * 0.20) + (tempM25 * 0.25);
                amount = tempM20 + tempM25;
            }

            state.sales = state.sales.filter(s => !(s.date === state.selectedDate && s.sellerId === sellerId && s.shift === shift));
            state.sales.push({ 
                date: state.selectedDate, sellerId, shift, amount, 
                commissionType: tempType, commission, 
                mixto20: tempType === 'mixto' ? tempM20 : undefined, 
                mixto25: tempType === 'mixto' ? tempM25 : undefined 
            });
            state.modals.commission.show = false;
            save();
        }

        // SETTINGS HANDLERS
        function moveItem(id, type, dir) {
            const list = state[type + 's'];
            const idx = list.findIndex(i => i.id === id);
            const target = dir === 'up' ? idx - 1 : idx + 1;
            if (target < 0 || target >= list.length) return;
            const temp = list[idx].order;
            list[idx].order = list[target].order;
            list[target].order = temp;
            save();
        }

        function updateName(id, type, name) {
            const item = state[type + 's'].find(i => i.id === id);
            if (item) item.name = name;
            save();
        }

        function addItem(type) {
            const list = state[type + 's'];
            const id = Date.now().toString();
            const order = list.length > 0 ? Math.max(...list.map(i => i.order)) + 1 : 0;
            list.push({ id, name: `Nuevo ${type}`, active: true, order });
            save();
        }

        function toggleActive(id, type) {
            const item = state[type + 's'].find(i => i.id === id);
            if (item) item.active = !item.active;
            save();
        }

        async function handleImage(id, type, file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 120;
                    const scale = MAX / img.width;
                    canvas.width = MAX;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.6);
                    const item = state[type + 's'].find(i => i.id === id);
                    if (item) item.image = base64;
                    save();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- COMPONENTES DE RENDERIZADO ---
        function renderHeader() {
            return `
            <header class="${getTC('bg')} ${getTC('headerText')} p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 flex items-center justify-center">
                        <div onclick="save()" class="w-8 h-8 bg-white/60 rounded-lg flex items-center justify-center shadow-sm relative overflow-hidden cursor-pointer transition-all active:scale-90 ${state.saveStatus !== 'idle' ? 'scale-125' : ''}">
                             <div class="${state.saveStatus === 'success' ? 'text-lime-500' : getTC('text')}">${ICONS.triangle}</div>
                        </div>
                    </div>
                    <h1 class="text-xl font-black tracking-tighter">TRIANGULO APP</h1>
                </div>
                <button onclick="state.view = state.view === 'settings' ? 'morning' : 'settings'; render();" class="p-2 rounded-full transition-all ${state.view === 'settings' ? 'bg-white shadow-sm ' + getTC('text') : 'bg-white/40'}">
                    ${state.view === 'settings' ? ICONS.close : ICONS.settings}
                </button>
            </header>`;
        }

        function renderDatePicker() {
            return `
            <div class="${state.isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-200'} border-b p-2 flex items-center justify-between sticky top-[64px] z-40">
                <button onclick="changeDate(-1)" class="p-2 ${getTC('text')}">${ICONS.chevronLeft}</button>
                <div class="flex items-center gap-2 ${state.isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-100'} px-4 py-2 rounded-xl border shadow-sm">
                   <div class="${getTC('text')} w-4 h-4">${ICONS.calendar}</div>
                   <input type="date" value="${state.selectedDate}" onchange="state.selectedDate = this.value; save();" class="bg-transparent text-sm font-bold focus:outline-none ${state.isDarkMode ? 'text-white' : 'text-gray-700'}" />
                </div>
                <button onclick="changeDate(1)" class="p-2 ${getTC('text')}">${ICONS.chevronRight}</button>
            </div>`;
        }

        function renderMorningAfternoon() {
            const shift = state.view;
            const sellers = state.sellers
                .filter(s => s.active)
                .sort((a, b) => (getSaleAmount(b.id, shift) - getSaleAmount(a.id, shift)) || (a.order - b.order));

            return `
            <div class="space-y-4 animate-in">
                <div class="${getCardBg()} p-4 rounded-2xl shadow-sm border">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-gray-500 text-xs font-black uppercase tracking-widest">Ventas ${shift === 'morning' ? 'Mañana' : 'Tarde'}</h2>
                        <button class="${getTC('text')}">${ICONS.download}</button>
                    </div>
                    <div class="space-y-3">
                        ${sellers.map(s => {
                            const entry = getSaleEntry(s.id, shift);
                            const hasCom = entry?.commissionType && entry.commissionType !== 'none';
                            return `
                            <div class="flex items-center justify-between gap-4 p-3 ${state.isDarkMode ? 'bg-gray-800' : 'bg-gray-50'} rounded-xl border ${state.isDarkMode ? 'border-gray-700' : 'border-gray-100'}">
                                <div class="flex items-center gap-3">
                                    <div onclick="openCommission('${s.id}', '${shift}')" class="w-10 h-10 rounded-xl bg-white border flex items-center justify-center text-gray-300 shadow-inner cursor-pointer ${hasCom ? 'ring-4 ring-emerald-500 ring-offset-2' : ''}">
                                        ${s.image ? `<img src="${s.image}" class="w-full h-full object-cover rounded-xl"/>` : ICONS.camera}
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm">${s.name}</span>
                                        ${hasCom ? `<span class="text-[10px] font-black text-emerald-500 uppercase">Com: $${formatC(entry.commission)}</span>` : ''}
                                    </div>
                                </div>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 ${getTC('text')} font-bold opacity-40">$</span>
                                    <input type="number" value="${entry?.amount || ''}" oninput="updateSale('${s.id}', '${shift}', this.value)" class="w-28 pl-7 pr-3 py-2 ${getInputBg()} rounded-lg text-right font-black shadow-inner outline-none focus:ring-2 ${getTC('ring')}" />
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>`;
        }

        function renderPayments() {
            return `
            <div class="space-y-4 animate-in">
                <div class="${getCardBg()} p-4 rounded-2xl shadow-sm border">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-rose-500 text-xs font-black uppercase tracking-widest">Pagos a Vendedores</h2>
                        <button class="text-rose-600">${ICONS.download}</button>
                    </div>
                    <div class="space-y-4">
                        ${state.sellers.filter(s => s.active).map(s => {
                            const isCalc = state.payments.some(p => p.date === state.selectedDate && p.sellerId === s.id && p.calculated);
                            const mBg = state.isDarkMode ? 'bg-yellow-400/20 border-yellow-500/30' : 'bg-yellow-50 border-yellow-100';
                            const tBg = state.isDarkMode ? 'bg-blue-400/20 border-blue-500/30' : 'bg-blue-50 border-blue-100';
                            return `
                            <div class="p-3 rounded-xl border ${state.isDarkMode ? 'border-gray-800 bg-gray-800/50' : 'border-gray-50 bg-gray-50/50'}">
                                <div class="flex items-center gap-3 mb-3">
                                    <div onclick="alert('Calculadora disponible en v2')" class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-gray-300 shadow-inner cursor-pointer ${isCalc ? 'ring-4 ring-emerald-500 ring-offset-2' : ''}">
                                        ${s.image ? `<img src="${s.image}" class="w-full h-full object-cover rounded-xl"/>` : ICONS.camera}
                                    </div>
                                    <span class="font-bold">${s.name}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-rose-300 font-bold text-xs">$</span>
                                        <input type="number" value="${getPaymentAmount(s.id, 'morning') || ''}" oninput="updatePayment('${s.id}', 'morning', this.value)" class="w-full pl-6 pr-2 py-2 ${mBg} border rounded-lg text-right font-black text-rose-600 outline-none" />
                                    </div>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-rose-300 font-bold text-xs">$</span>
                                        <input type="number" value="${getPaymentAmount(s.id, 'afternoon') || ''}" oninput="updatePayment('${s.id}', 'afternoon', this.value)" class="w-full pl-6 pr-2 py-2 ${tBg} border rounded-lg text-right font-black text-rose-600 outline-none" />
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>`;
        }

        function renderClosure() {
            const data = calculateSummary();
            const mBg = state.isDarkMode ? 'bg-yellow-400/20 border-yellow-500/30' : 'bg-yellow-50 border-yellow-100';
            const tBg = state.isDarkMode ? 'bg-blue-400/20 border-blue-500/30' : 'bg-blue-50 border-blue-100';

            return `
            <div class="space-y-4 animate-in pb-12">
                ${state.branches.filter(b => b.active).map(b => {
                    const closure = state.branchClosures.find(bc => bc.date === state.selectedDate && bc.branchId === b.id) || { morningAmount: 0, afternoonAmount: 0 };
                    return `
                    <div class="${getCardBg()} p-4 rounded-2xl shadow-sm border">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl overflow-hidden bg-gray-100">${b.image ? `<img src="${b.image}" class="w-full h-full object-cover"/>` : ICONS.camera}</div>
                            <h3 class="font-black ${getTC('text')} uppercase tracking-tight">${b.name}</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" value="${closure.morningAmount || ''}" oninput="updateBranchClosure('${b.id}', 'morningAmount', this.value)" placeholder="Mañana" class="w-full p-3 ${mBg} border rounded-xl font-black text-center" />
                            <input type="number" value="${closure.afternoonAmount || ''}" oninput="updateBranchClosure('${b.id}', 'afternoonAmount', this.value)" placeholder="Tarde" class="w-full p-3 ${tBg} border rounded-xl font-black text-center" />
                        </div>
                    </div>`;
                }).join('')}

                <div class="${getCardBg()} p-4 rounded-2xl shadow-sm border">
                    <h3 class="text-gray-500 text-xs font-black uppercase mb-4 tracking-widest border-b pb-2">Extras y Terminales</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <span class="text-[9px] font-bold uppercase text-rose-400">Gastos M / T</span>
                                <div class="flex gap-2">
                                    <input type="number" value="${getExtraAmount('gasto', 'morning') || ''}" oninput="updateExtra('gasto', 'morning', this.value)" class="w-full p-2 ${mBg} border-rose-200 border rounded-lg text-rose-600 font-black" />
                                    <input type="number" value="${getExtraAmount('gasto', 'afternoon') || ''}" oninput="updateExtra('gasto', 'afternoon', this.value)" class="w-full p-2 ${tBg} border-rose-200 border rounded-lg text-rose-600 font-black" />
                                </div>
                            </div>
                            <div class="space-y-1">
                                <span class="text-[9px] font-bold uppercase text-rose-400">Garantías M / T</span>
                                <div class="flex gap-2">
                                    <input type="number" value="${getExtraAmount('garantia', 'morning') || ''}" oninput="updateExtra('garantia', 'morning', this.value)" class="w-full p-2 ${mBg} border-rose-200 border rounded-lg text-rose-600 font-black" />
                                    <input type="number" value="${getExtraAmount('garantia', 'afternoon') || ''}" oninput="updateExtra('garantia', 'afternoon', this.value)" class="w-full p-2 ${tBg} border-rose-200 border rounded-lg text-rose-600 font-black" />
                                </div>
                            </div>
                        </div>

                        ${state.terminals.filter(t => t.active).map(t => `
                        <div class="p-3 rounded-xl border ${state.isDarkMode ? 'border-gray-800 bg-gray-800/50' : 'border-gray-50 bg-gray-50/50'}">
                            <div class="flex items-center gap-2 mb-2"><span class="font-bold text-xs">${t.name}</span></div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" value="${getTerminalAmount(t.id, 'morning') || ''}" oninput="updateTerminal('${t.id}', 'morning', this.value)" class="w-full p-2 ${mBg} border rounded-lg font-black text-right" />
                                <input type="number" value="${getTerminalAmount(t.id, 'afternoon') || ''}" oninput="updateTerminal('${t.id}', 'afternoon', this.value)" class="w-full p-2 ${tBg} border rounded-lg font-black text-right" />
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="${getCardBg()} p-4 rounded-2xl shadow-sm border border-dashed border-gray-300">
                    <h3 class="text-xs font-black uppercase mb-4 tracking-widest text-center text-gray-400">Resumen Efectivo</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="${mBg} p-3 rounded-xl text-center"><p class="text-[10px] font-black opacity-50">Efectivo M</p><p class="text-xl font-black text-yellow-700">$ ${formatC(data.morningCash)}</p></div>
                        <div class="${tBg} p-3 rounded-xl text-center"><p class="text-[10px] font-black opacity-50">Efectivo T</p><p class="text-xl font-black text-blue-700">$ ${formatC(data.afternoonCash)}</p></div>
                    </div>
                </div>
            </div>`;
        }

        function renderSummary() {
            const data = calculateSummary();
            return `
            <div class="space-y-4 animate-in">
                <div class="${getCardBg()} p-6 rounded-3xl shadow-xl border overflow-hidden relative" onclick="copySummary()">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-black text-xl ${getTC('text')}">${formatDateSpanish(state.selectedDate)}</h2>
                        <div class="${getTC('text')}">${ICONS.download}</div>
                    </div>
                    <div class="mb-6 space-y-2">
                        ${data.detailByBranch.map(b => `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-50">
                            <span class="text-gray-500">${b.name}</span>
                            <span class="font-black ${getTC('text')}">$ ${formatC(b.total)}</span>
                        </div>`).join('')}
                        <div class="flex justify-between font-black text-lg pt-2 ${getTC('text')}"><span>TOTAL VENTAS</span><span>$ ${formatC(data.totalGross)}</span></div>
                    </div>
                    <div class="mb-8 space-y-3 pt-4 border-t border-gray-100">
                        <h3 class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Deducciones</h3>
                        ${data.groupedPayments.map(p => `<div class="flex justify-between text-xs pl-2"><span class="italic text-gray-400">${p.name}</span><span class="font-bold text-rose-500">-$ ${formatC(p.amount)}</span></div>`).join('')}
                        ${Object.entries(data.groupedExtras).map(([k,v]) => `<div class="flex justify-between text-sm pl-2"><span class="font-medium">${k}:</span><span class="font-black text-rose-500">-$ ${formatC(v.amount)}</span></div>`).join('')}
                        <div class="flex justify-between text-lg pt-4 border-t border-gray-100 font-black"><span>TOTAL DÍA</span><span>$ ${formatC(data.totalDay)}</span></div>
                        <div class="flex justify-between text-sm opacity-60"><span>Cobro Terminales:</span><span class="font-black">-$ ${formatC(data.totalTerminals)}</span></div>
                    </div>
                    <div class="${getTC('bg')} ${getTC('headerText')} p-6 rounded-2xl shadow-lg border-2 ${getTC('border')} relative overflow-hidden text-center">
                        <p class="text-xs uppercase font-black opacity-60 mb-1">Efectivo Total a Entregar</p>
                        <p class="text-5xl font-black">$ ${formatC(data.totalCash)}</p>
                    </div>
                </div>
            </div>`;
        }

        function renderSettings() {
            return `
            <div class="space-y-6 animate-in pb-12">
                <div class="${state.isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-200'} p-5 rounded-2xl shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2"><div class="${getTC('text')} w-5 h-5">${ICONS.palette}</div><h2 class="font-black text-lg">Personalización</h2></div>
                        <button onclick="state.isDarkMode = !state.isDarkMode; save();" class="p-2 rounded-xl border">${state.isDarkMode ? ICONS.sun : ICONS.moon}</button>
                    </div>
                    <div class="flex justify-between gap-2">
                        ${Object.keys(themeColors).map(t => `<button onclick="state.theme='${t}'; save();" class="w-8 h-8 rounded-full border-2 ${state.theme === t ? 'ring-2 ring-indigo-300' : ''} ${themeColors[t].dot}"></button>`).join('')}
                    </div>
                </div>

                ${['seller', 'branch', 'terminal'].map(type => {
                    const label = type === 'seller' ? 'Vendedores' : type === 'branch' ? 'Sucursales' : 'Terminales';
                    const list = [...state[type + 's']].sort((a,b) => a.order - b.order);
                    return `
                    <div class="${getCardBg()} p-5 rounded-2xl shadow-sm border">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="font-black text-xl">${label}</h2>
                            <button onclick="addItem('${type}')" class="p-2 px-4 ${getTC('btn')} text-white rounded-full text-xs font-black shadow-sm">+ AÑADIR</button>
                        </div>
                        <div class="space-y-3">
                            ${list.map((item, idx) => `
                            <div class="flex items-center justify-between p-3 rounded-xl border ${item.active ? 'bg-white' : 'bg-gray-100 opacity-60'}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gray-50 border relative overflow-hidden flex items-center justify-center text-gray-300">
                                        <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImage('${item.id}', '${type}', this.files[0])" />
                                        ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover"/>` : ICONS.camera}
                                    </div>
                                    <input type="text" value="${item.name}" onchange="updateName('${item.id}', '${type}', this.value)" class="font-black text-sm bg-transparent border-none focus:ring-0 outline-none w-24" />
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-col">
                                        <button onclick="moveItem('${item.id}', '${type}', 'up')" class="p-1 opacity-30 hover:opacity-100" ${idx === 0 ? 'disabled' : ''}>${ICONS.arrowUp}</button>
                                        <button onclick="moveItem('${item.id}', '${type}', 'down')" class="p-1 opacity-30 hover:opacity-100" ${idx === list.length-1 ? 'disabled' : ''}>${ICONS.arrowDown}</button>
                                    </div>
                                    <button onclick="toggleActive('${item.id}', '${type}')" class="p-2 rounded-xl ${item.active ? 'text-emerald-500 bg-emerald-50' : 'text-gray-400'}">
                                        ${item.active ? ICONS.eye : ICONS.eyeOff}
                                    </button>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderNavigation() {
            const items = [
                { id: 'morning', label: 'MAÑANA', icon: 'sun' },
                { id: 'afternoon', label: 'TARDE', icon: 'moon' },
                { id: 'payments', label: 'PAGOS', icon: 'banknote' },
                { id: 'closure', label: 'CIERRE', icon: 'clipboard' },
                { id: 'summary', label: 'RESUMEN', icon: 'dashboard' },
            ];
            const activeC = state.isDarkMode ? getTC('text') : getTC('text');
            const activeBg = state.isDarkMode ? 'bg-indigo-900/30' : getTC('bg');

            return `
            <nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-gray-950/90 backdrop-blur-xl border-t px-1 py-2 pb-safe z-50 flex justify-around max-w-lg mx-auto shadow-lg">
                ${items.map(item => {
                    const isActive = state.view === item.id;
                    return `
                    <button onclick="state.view='${item.id}'; render();" class="flex flex-col items-center justify-center p-2 rounded-xl transition-all flex-1 ${isActive ? activeC + ' ' + activeBg + ' scale-105' : 'text-gray-400'}">
                        <div class="w-5 h-5">${ICONS[item.icon]}</div>
                        <span class="text-[7px] mt-1 font-black uppercase tracking-tight">${item.label}</span>
                    </button>`;
                }).join('')}
            </nav>`;
        }

        // --- MODALES ---
        function renderModals() {
            if (state.modals.commission.show) {
                const { tempType, tempM20, tempM25, sellerId, shift } = state.modals.commission;
                const sale = getSaleAmount(sellerId, shift);
                let calculo = 0;
                if (['10', '20', '25'].includes(tempType)) calculo = sale * (parseFloat(tempType) / 100);
                else if (tempType === 'mixto') calculo = (tempM20 * 0.20) + (tempM25 * 0.25);

                return `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in">
                    <div class="${getCardBg()} w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden border">
                        <div class="${getTC('bg')} p-6 flex justify-between items-center border-b">
                            <div class="flex items-center gap-2"><div class="${getTC('text')} w-5 h-5">${ICONS.percent}</div><h3 class="font-black ${getTC('text')} uppercase">Comisión</h3></div>
                            <button onclick="state.modals.commission.show=false; render();" class="p-2">${ICONS.close}</button>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="flex gap-2">
                                ${['10', '20', '25', 'mixto'].map(type => `
                                <button onclick="state.modals.commission.tempType='${type}'; render();" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase border ${tempType === type ? getTC('btn') + ' text-white' : 'bg-gray-100'}">${type === 'mixto' ? 'Mixto' : type+'%'}</button>
                                `).join('')}
                            </div>
                            ${tempType === 'mixto' ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" value="${tempM20 || ''}" oninput="state.modals.commission.tempM20=parseFloat(this.value)||0; render();" placeholder="Venta 20%" class="p-3 border rounded-xl font-black text-center ${getInputBg()}" />
                                    <input type="number" value="${tempM25 || ''}" oninput="state.modals.commission.tempM25=parseFloat(this.value)||0; render();" placeholder="Venta 25%" class="p-3 border rounded-xl font-black text-center ${getInputBg()}" />
                                </div>
                            ` : `<div class="text-center"><p class="text-2xl font-black">$ ${formatC(sale)}</p></div>`}
                            <div class="p-5 rounded-2xl bg-emerald-50 text-center border border-emerald-200">
                                <p class="text-emerald-600 font-black text-[10px] uppercase">Comisión Estimada</p>
                                <p class="text-4xl font-black text-emerald-600">$ ${formatC(calculo)}</p>
                            </div>
                            <button onclick="saveCommission()" class="w-full py-4 rounded-2xl ${getTC('btn')} text-white font-black uppercase text-sm shadow-xl">GUARDAR COMISIÓN</button>
                        </div>
                    </div>
                </div>`;
            }
            return '';
        }

        // --- CORE RENDER ---
        function render() {
            const root = document.getElementById('root');
            let content = renderHeader() + renderDatePicker();
            
            const main = document.createElement('main');
            main.className = "flex-1 p-4 max-w-lg mx-auto w-full pb-24";
            
            if (state.view === 'morning' || state.view === 'afternoon') main.innerHTML = renderMorningAfternoon();
            else if (state.view === 'payments') main.innerHTML = renderPayments();
            else if (state.view === 'closure') main.innerHTML = renderClosure();
            else if (state.view === 'summary') main.innerHTML = renderSummary();
            else if (state.view === 'settings') main.innerHTML = renderSettings();

            root.innerHTML = content;
            root.appendChild(main);
            root.insertAdjacentHTML('beforeend', renderNavigation());
            root.insertAdjacentHTML('beforeend', renderModals());
        }

        // --- INICIALIZACIÓN ---
        loadData();
        render();

        function copySummary() {
            const data = calculateSummary();
            const text = `${formatDateSpanish(state.selectedDate)}
            
DETALLE SUCURSALES:
${data.detailByBranch.map(b => `${b.name}: $${formatC(b.total)}`).join('\n')}
TOTAL VENTAS: $${formatC(data.totalGross)}

DEDUCCIONES:
$${formatC(data.totalDeductions)}
*TOTAL DÍA: $${formatC(data.totalDay)}*
TOTAL EFECTIVO: $${formatC(data.totalCash)}`;
            navigator.clipboard.writeText(text);
            alert('Resumen copiado');
        }

    </script>
</body>
</html>
